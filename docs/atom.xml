<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
	<title>Macroquad</title>
	<subtitle>Macroquad is a simple and easy to use game library for Rust programming language.</subtitle>
	<link href="https://macroquad.rs/atom.xml" rel="self" type="application/atom+xml"/>
  <link href="https://macroquad.rs/"/>
	<generator uri="https://www.getzola.org/">Zola</generator>
	<updated>2022-10-31T10:19:42+00:00</updated>
	<id>https://macroquad.rs/atom.xml</id>
	<entry xml:lang="en">
		<title>Macroquad on IOS</title>
		<published>2022-10-31T09:19:42+00:00</published>
		<updated>2022-10-31T10:19:42+00:00</updated>
		<link rel="alternate" href="https://macroquad.rs/articles/ios/" type="text/html"/>
		<id>https://macroquad.rs/articles/ios/</id>
		<content type="html">&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;macroquad.rs&#x2F;articles&#x2F;ios&#x2F;ios_zemeroth.png&quot; alt=&quot;zemeroth&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;h1 id=&quot;setting-up-a-macroquad-project&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#setting-up-a-macroquad-project&quot; aria-label=&quot;Anchor link for: setting-up-a-macroquad-project&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Setting up a macroquad project&lt;&#x2F;h1&gt;
&lt;p&gt;This article assume that all the commands are invoked in the root folder of any mini&#x2F;macroquad based project. For simplicity, lets assumet that this project was created like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; cargo init mygame
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; cd mygame
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; cargo add macroquad
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; cat &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; src&#x2F;main.rs &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;lt;&amp;lt; EOF
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;use macroquad::prelude::*;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;#[macroquad::main(&amp;quot;MyGame&amp;quot;)]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;async fn main() {
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;    loop {
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;        clear_background(RED);
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;        draw_circle(200.0, 200.0, 60.0, YELLOW);
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;        next_frame().await
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;    }
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;}
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;EOF
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;building-for-the-simulator&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#building-for-the-simulator&quot; aria-label=&quot;Anchor link for: building-for-the-simulator&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Building for the simulator&lt;&#x2F;h1&gt;
&lt;p&gt;IOS application is just a normal folder, named like &amp;quot;MyGame.app&amp;quot;. This folder contains the binary, a file with a metadata and all the resources.&lt;br &#x2F;&gt;
The binary is a normal, cargo-produced, binary and resources are normal files, just like on any other platform. There is no third-party post-processors, resource compilators or anything like this.&lt;br &#x2F;&gt;
Create a folder, copy your binary and resources and it is a valid IOS application!&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span&gt;mkdir MyGame.app
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;cargo build --target x86_64-apple-ios --release
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;cp target&#x2F;x86_64-apple-ios&#x2F;release&#x2F;mygame MyGame.app
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;cat &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; MyGame.app&#x2F;Info.plist &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;lt;&amp;lt; EOF
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;!DOCTYPE plist PUBLIC &amp;quot;-&#x2F;&#x2F;Apple&#x2F;&#x2F;DTD PLIST 1.0&#x2F;&#x2F;EN&amp;quot; &amp;quot;http:&#x2F;&#x2F;www.apple.com&#x2F;DTDs&#x2F;PropertyList-1.0.dtd&amp;quot;&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;plist version=&amp;quot;1.0&amp;quot;&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;dict&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;key&amp;gt;CFBundleExecutable&amp;lt;&#x2F;key&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;string&amp;gt;mygame&amp;lt;&#x2F;string&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;key&amp;gt;CFBundleIdentifier&amp;lt;&#x2F;key&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;string&amp;gt;com.mygame&amp;lt;&#x2F;string&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;key&amp;gt;CFBundleName&amp;lt;&#x2F;key&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;string&amp;gt;mygame&amp;lt;&#x2F;string&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;key&amp;gt;CFBundleVersion&amp;lt;&#x2F;key&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;string&amp;gt;1&amp;lt;&#x2F;string&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;key&amp;gt;CFBundleShortVersionString&amp;lt;&#x2F;key&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;string&amp;gt;1.0&amp;lt;&#x2F;string&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;&#x2F;dict&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;&#x2F;plist&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;EOF
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;# only once, to get the emulator running
&lt;&#x2F;span&gt;&lt;span&gt;xcrun simctl list
&lt;&#x2F;span&gt;&lt;span&gt;xcrun simctl boot LONG_HEX_ID_OF_REQUIRED_IPHONE_FROM_SIMCTL_LIST
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;# also just once, to show the simulator UI
&lt;&#x2F;span&gt;&lt;span&gt;open &#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Applications&#x2F;Simulator.app&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;# on each build, to run the game
&lt;&#x2F;span&gt;&lt;span&gt;xcrun simctl install booted MyGame.app&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;xcrun simctl launch booted com.mygame
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;strong&gt;note&lt;&#x2F;strong&gt; on resources. All the files inside &amp;quot;MyGame.app&#x2F;assets&amp;quot; are accesible to &lt;code&gt;miniquad::fs&lt;&#x2F;code&gt; just like on any other platform.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span&gt;â”œâ”€â”€ MyGame.app
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â”œâ”€â”€ mygame
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â”œâ”€â”€ Info.plist
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â”œâ”€â”€ assets
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â”‚Â Â  â”œâ”€â”€ texture.png
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â”‚Â Â  â”œâ”€â”€ someronfile.ron
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;load_texture(&amp;quot;texture.png&amp;quot;)&lt;&#x2F;code&gt; or &lt;code&gt;load_file(&amp;quot;someronfile.ron&amp;quot;)&lt;&#x2F;code&gt; will work just fine.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;simulator-logs&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#simulator-logs&quot; aria-label=&quot;Anchor link for: simulator-logs&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Simulator logs&lt;&#x2F;h1&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span&gt;xcrun simctl spawn booted log stream --predicate &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;#39;processImagePath endswith &amp;quot;mygame&amp;quot;&amp;#39;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;deploying-on-the-real-device-with&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#deploying-on-the-real-device-with&quot; aria-label=&quot;Anchor link for: deploying-on-the-real-device-with&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Deploying on the real device with&lt;&#x2F;h1&gt;
&lt;p&gt;The real device use exactly the same &amp;quot;application bundle&amp;quot; format - its a &amp;quot;Name.app&amp;quot; folder with a binary, Info.plist and resources.&lt;&#x2F;p&gt;
&lt;p&gt;But real device use aarch64-apple-ios instead of x86_64-apple-ios and it requires the bundle to be signed.&lt;&#x2F;p&gt;
&lt;p&gt;Which means - to install and run the app, following conditions should be met:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;the bundle(Name.app folder) should contain a &amp;quot;embedded.mobileprovision&amp;quot; file&lt;&#x2F;li&gt;
&lt;li&gt;in iphone&#x27;s settings, in General -&amp;gt; &amp;quot;VPN &amp;amp; Device Management&amp;quot; should be a record with your team name&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;getting-provisioning-profile-files&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#getting-provisioning-profile-files&quot; aria-label=&quot;Anchor link for: getting-provisioning-profile-files&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Getting provisioning profile files&lt;&#x2F;h2&gt;
&lt;p&gt;This is ridicoulosly painful proces. Brace yourself!
Good news - its only a one time thing. With all the certificates being available installing the app to an iphone works just as smooth as to the simulator!&lt;&#x2F;p&gt;
&lt;p&gt;A lot of credits goes to this article: This article helped A TON: https:&#x2F;&#x2F;medium.com&#x2F;@vojtastavik&#x2F;building-an-ios-app-without-xcodes-build-system-d3e5ca86d30d
It is a bit outdated, some CLI arguments are a bit different now, but, in general, it was incredibly instrumental to get all this done!&lt;&#x2F;p&gt;
&lt;h3 id=&quot;prerequisites&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#prerequisites&quot; aria-label=&quot;Anchor link for: prerequisites&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Prerequisites&lt;&#x2F;h3&gt;
&lt;ul&gt;
&lt;li&gt;free appstore account&lt;&#x2F;li&gt;
&lt;li&gt;macos 10.15+ (probably 10.14 works as well)&lt;&#x2F;li&gt;
&lt;li&gt;xcode 11+&lt;&#x2F;li&gt;
&lt;li&gt;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ios-control&#x2F;ios-deploy&quot;&gt;ios-deploy&lt;&#x2F;a&gt; tool. (&lt;code&gt;brew install ios-deploy&lt;&#x2F;code&gt;)&lt;&#x2F;li&gt;
&lt;li&gt;any ios device&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h3 id=&quot;connecting-phone-with-xcode&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#connecting-phone-with-xcode&quot; aria-label=&quot;Anchor link for: connecting-phone-with-xcode&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Connecting phone with xcode&lt;&#x2F;h3&gt;
&lt;p&gt;On the first connection, both xcode and macos might complain about versions incompatibility.
MacOs complains may be just ignored, but to make XCode recognise the device:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;double check that there is a folder with Iphone&#x27;s ios version here: &lt;code&gt;&#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Platforms&#x2F;iPhoneOS.platform&#x2F;DeviceSupport&lt;&#x2F;code&gt;&lt;&#x2F;li&gt;
&lt;li&gt;if no - download the required file somewhere from the internet(there are a lot of repos on github with such a data).&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;The goal of this step - to see a new device available in &lt;code&gt;Xcode -&amp;gt; Window -&amp;gt; Devices and Simulators&lt;&#x2F;code&gt;&lt;&#x2F;p&gt;
&lt;h3 id=&quot;on-devicesupport-files&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#on-devicesupport-files&quot; aria-label=&quot;Anchor link for: on-devicesupport-files&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;On DeviceSupport files&lt;&#x2F;h3&gt;
&lt;p&gt;Any(11+ at least) xcode could install provision files on any IOS device!&lt;&#x2F;p&gt;
&lt;p&gt;On pre 16 iOs, the only requirement is a little file in &amp;quot;&#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;Developer&#x2F;Platforms&#x2F;iPhoneOS.platform&#x2F;DeviceSupport&amp;quot;&lt;&#x2F;p&gt;
&lt;p&gt;Post iOs 16, iPhone should be in a &amp;quot;Developer mode&amp;quot; to be able to receive the provisions. However, the &amp;quot;Developer mode&amp;quot; toggle is hidden in the settings until device seen a mac with xcode 14 installed at least once. Yes, you need to physically connect your iPhone to any Mac with XCode 14 to get a toggle in the menu! &lt;&#x2F;p&gt;
&lt;p&gt;There are, however, scatchy third-party tools(&amp;quot;iCareFone 2&amp;quot; did it for me) to get this very toggle. With this toggle on, XCode11 with &amp;quot;16.2&amp;quot; in &amp;quot;DeviceSupport&amp;quot; folder can successefully install the provisions on the iphone.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;mobileprovision-file&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#mobileprovision-file&quot; aria-label=&quot;Anchor link for: mobileprovision-file&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;.mobileprovision file&lt;&#x2F;h3&gt;
&lt;p&gt;Purpose of this step - create an empty xcode project runnable on the iphone. This project will be never used for building anything, just to make xcode to download provision files from apple developer portal. &lt;&#x2F;p&gt;
&lt;p&gt;First, login to the app store account. (it might be a free account, no need for the developer one). &lt;code&gt;xcode-&amp;gt;preferences-&amp;gt;account login create team&lt;&#x2F;code&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Than create a new dummy project with the desired bundle indentifier (&lt;code&gt;com.mygame&lt;&#x2F;code&gt;).&lt;&#x2F;p&gt;
&lt;p&gt;Run it on the device.&lt;&#x2F;p&gt;
&lt;p&gt;If xcode complains with &amp;quot;-402620375&amp;quot; (and no other explanations) - add &lt;code&gt;--generate-entitlement-der&lt;&#x2F;code&gt; to &lt;code&gt;Project -&amp;gt; Build Settings -&amp;gt; Other Code Signing Flags&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;This will create a runnable app on the phone and make two provision files in &lt;code&gt;~&#x2F;Library&#x2F;MobileDevice&#x2F;Provisioning\ Profiles&#x2F;&lt;&#x2F;code&gt;.
One for &amp;quot;com.mygame&amp;quot; and one for &amp;quot;com.mygameUITests&amp;quot;. To find which one is which &lt;code&gt;cat ~&#x2F;Library&#x2F;MobileDevice&#x2F;Provisioning\ Profiles&#x2F;lotsofhex.mobileprovision | grep -a UITests&lt;&#x2F;code&gt;. The one that doesnt have UITests in it is the one!&lt;&#x2F;p&gt;
&lt;p&gt;Copy it to MyApp.app&#x2F;embedded.mobileprovision&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;Note&lt;&#x2F;strong&gt; for the paid apple developer account - with the developer account this step may be skipped alltogether, provision profiles could be downloaded from the iOS developer portal.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;scent-file&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#scent-file&quot; aria-label=&quot;Anchor link for: scent-file&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;.scent file&lt;&#x2F;h3&gt;
&lt;p&gt;&lt;code&gt;.scent&lt;&#x2F;code&gt; file contains all the metadata for signing the bundle.&lt;&#x2F;p&gt;
&lt;p&gt;First, get a team id (the team is a thing created in xcode in the previous step).&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; cat mygame_provisionsfetch.xcodeproj&#x2F;project.pbxproj &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;| &lt;&#x2F;span&gt;&lt;span&gt;grep DEVELOPMENT_TEAM
&lt;&#x2F;span&gt;&lt;span&gt;DEVELOPMENT_TEAM = YOURID&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;em&gt;mygame_provisionsfetch.xcodeproj&lt;&#x2F;em&gt; is our dummy provisions-fetching project.&lt;&#x2F;p&gt;
&lt;p&gt;Than create a &lt;code&gt;.scent&lt;&#x2F;code&gt; file next to the &lt;code&gt;MyGame.app&lt;&#x2F;code&gt; folder:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span&gt;cat &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; MyGame.scent &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;lt;&amp;lt; EOF
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;!DOCTYPE plist PUBLIC &amp;quot;-&#x2F;&#x2F;Apple&#x2F;&#x2F;DTD PLIST 1.0&#x2F;&#x2F;EN&amp;quot; &amp;quot;http:&#x2F;&#x2F;www.apple.com&#x2F;DTDs&#x2F;PropertyList-1.0.dtd&amp;quot;&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;plist version=&amp;quot;1.0&amp;quot;&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;dict&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;	&amp;lt;key&amp;gt;application-identifier&amp;lt;&#x2F;key&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;	&amp;lt;string&amp;gt;G92KM8UVQS.com.iwantprovisions&amp;lt;&#x2F;string&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;	&amp;lt;key&amp;gt;com.apple.developer.team-identifier&amp;lt;&#x2F;key&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;	&amp;lt;string&amp;gt;MYTEAMID&amp;lt;&#x2F;string&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;	&amp;lt;key&amp;gt;get-task-allow&amp;lt;&#x2F;key&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;	&amp;lt;true&#x2F;&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;	&amp;lt;key&amp;gt;keychain-access-groups&amp;lt;&#x2F;key&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;	&amp;lt;array&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;		&amp;lt;string&amp;gt;MYTEAMID.com.mygame&amp;lt;&#x2F;string&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;	&amp;lt;&#x2F;array&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;&#x2F;dict&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;lt;&#x2F;plist&amp;gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;EOF
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;â”œâ”€â”€ MyGame.app
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â”œâ”€â”€ mygame
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â”œâ”€â”€ Info.plist
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â”œâ”€â”€ assets
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â”‚Â Â  â”œâ”€â”€ texture.png
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â”‚Â Â  â”œâ”€â”€ someronfile.ron
&lt;&#x2F;span&gt;&lt;span&gt;â”œâ”€â”€ MyGame.scent
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;sign-it&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#sign-it&quot; aria-label=&quot;Anchor link for: sign-it&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;sign it&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;# this should show the certificate previously created in xcode
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;# copy the very long hex id from the certificate
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; security find-identity -v -p codesigning
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;# and use it here to sign the binary
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; codesign --force --timestamp&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt;none --sign LONGHEXID mygame
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;# and sign the bundle itself
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; codesign --force --timestamp&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt;none --sign LONGHEXID --scent MyGame.scent --generate-entitlement-der MyGame.app
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h3 id=&quot;deploy-it&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#deploy-it&quot; aria-label=&quot;Anchor link for: deploy-it&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;deploy it&lt;&#x2F;h3&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; ios-deploy -c
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; ios-deploy -i HEXDEVICEID -b MyGame.app
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;build-scripts&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#build-scripts&quot; aria-label=&quot;Anchor link for: build-scripts&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Build scripts&lt;&#x2F;h1&gt;
&lt;p&gt;When all the groundwork is done those scripts will deploy run the game on the simulator&#x2F;real device.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;emulator&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#emulator&quot; aria-label=&quot;Anchor link for: emulator&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Emulator&lt;&#x2F;h2&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span&gt;cargo build --target x86_64-apple-ios
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;# if assets are updated all the time - copy them on each build
&lt;&#x2F;span&gt;&lt;span&gt;cp -r assets MyGame.app&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;# note debug&#x2F;release
&lt;&#x2F;span&gt;&lt;span&gt;cp target&#x2F;x86_64-apple-ios&#x2F;debug&#x2F;mygame MyGame.app&#x2F;mygame
&lt;&#x2F;span&gt;&lt;span&gt;xcrun simctl install booted MyGame.app&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;xcrun simctl launch booted com.mygame
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;real-device&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#real-device&quot; aria-label=&quot;Anchor link for: real-device&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Real device&lt;&#x2F;h2&gt;
&lt;pre data-lang=&quot;sh&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-sh &quot;&gt;&lt;code class=&quot;language-sh&quot; data-lang=&quot;sh&quot;&gt;&lt;span&gt;cargo build --target aarch64-apple-ios --release
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;# if assets are updated all the time - copy them on each build
&lt;&#x2F;span&gt;&lt;span&gt;cp -r assets MyGame.app&#x2F;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;# note debug&#x2F;release
&lt;&#x2F;span&gt;&lt;span&gt;cp target&#x2F;aarch64-apple-ios&#x2F;release&#x2F;mygame MyGame.app&#x2F;mygame
&lt;&#x2F;span&gt;&lt;span&gt;codesign --force --timestamp&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt;none --sign VERYLONGHEXID MyGame.app&#x2F;mygame
&lt;&#x2F;span&gt;&lt;span&gt;codesign --force --timestamp&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt;none --sign VERYLONGHEXID --scent MyGame.scent --generate-entitlement-der MyGame.app
&lt;&#x2F;span&gt;&lt;span&gt;ios-deploy -i HEXDEVICEID -b MyGame.app
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
</content>
	</entry>
	<entry xml:lang="en">
		<title>Java interop with Miniquad on Android</title>
		<published>2022-07-04T20:10:42+00:00</published>
		<updated>2022-07-04T20:10:42+00:00</updated>
		<link rel="alternate" href="https://macroquad.rs/articles/java/" type="text/html"/>
		<id>https://macroquad.rs/articles/java/</id>
		<content type="html">&lt;p&gt;Miniquad allows seamless integration of Java code, intagrating Java compilation into a rust build pipeline. This allows *quad project to get access to any Android APIs and an option to integrate any third-party Java libraries.&lt;&#x2F;p&gt;
&lt;p&gt;The article use a native file dialog as an example.&lt;&#x2F;p&gt;
&lt;p&gt;Code is available here: &lt;&#x2F;p&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;example-android-fileopen&#x2F;&quot;&gt;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;example-android-fileopen&#x2F;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;p&gt;More comprehensive example: &lt;&#x2F;p&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;example-android-bluetooth&#x2F;&quot;&gt;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;example-android-bluetooth&#x2F;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;p&gt;&lt;figure class=&quot;inline-image&quot;&gt;
	&lt;video controls autoplay playsinline muted loop&gt;
		&lt;source src=&quot;https:&amp;#x2F;&amp;#x2F;user-images.githubusercontent.com&amp;#x2F;910977&amp;#x2F;177233789-fefbf9c9-6c55-4151-804a-22b85dfa82de.mp4&quot; type=&quot;video&#x2F;mp4&quot;&gt;
		Your browser does not support the video tag.
	&lt;&#x2F;video&gt;
	
&lt;&#x2F;figure&gt;

&lt;em&gt;Bluetooth example asking for permissions. Surpisingly, its A LOT of java!&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;how-android-runs-things&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#how-android-runs-things&quot; aria-label=&quot;Anchor link for: how-android-runs-things&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;How android runs things&lt;&#x2F;h2&gt;
&lt;p&gt;First a brief introduction on how applications works on android. A bird&#x27;s eye view on how apps works on android, to find out where it is possible to insert some calls to get the fial dialog (or any native api, actually) to appear. &lt;&#x2F;p&gt;
&lt;p&gt;Each android package, .apk, is basically a zip archive with:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;classes.dex file - all the compiled java files&lt;&#x2F;li&gt;
&lt;li&gt;.so files - all the compiled binary code&lt;&#x2F;li&gt;
&lt;li&gt;some .xml&#x27;s with metadata, resources and assets&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Android will initialize java virtual machine and run the app inside this virtual machine. All the interactions with the OS goes through the virtual machine. &lt;&#x2F;p&gt;
&lt;p&gt;There are two ways to start android application, described in one of the .xml&#x27;s of the apk:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;skip classes.dex completely and tell android to load .so and call a few symbols to let the app initialize.&lt;&#x2F;li&gt;
&lt;li&gt;find a java class in classes.dex file and let it run.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Miniquad is using the second option - it have MainActivity.java that is responsible for initializing the app and receiving input events. And inside this MainActivity.java .so with user code is being loaded and some native functions from that .so are being called.&lt;&#x2F;p&gt;
&lt;p&gt;Why miniquad is not built around NativeActivity, the first option? Well, it used to be built around NativeActivity until 0.3, actually.
The problem here - some of the android API&#x27;s are really, really hard to use through java native interface. So it really helps when there is an option to make a wrapper for something in Java and provide an easy to use function for a native code.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;em&gt;A little remark on apks&lt;&#x2F;em&gt; Now instead of raw .apk developers will be forced to use .aab - a new format for applications on android. Each .aab is a bunch of signed .apk&#x27;s, so the idea is still the ssame.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;writing-some-java&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#writing-some-java&quot; aria-label=&quot;Anchor link for: writing-some-java&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Writing some java&lt;&#x2F;h3&gt;
&lt;p&gt;A short recap from previous section:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;miniquad has MainActivity.java&lt;&#x2F;li&gt;
&lt;li&gt;it creates an OS window and load .so with user code&lt;&#x2F;li&gt;
&lt;li&gt;it pass all the events to this .so through calling native functions from .so&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;The way miniquad&#x27;s native plugins are built are very similar to UE4 android plugin&#x27;s idea(just in case the reader is familiar with UE4&#x2F;Android interop).&lt;&#x2F;p&gt;
&lt;p&gt;We can ask the build system to insert some code right to the MainActivity.java. And we can as the build system to add compile some .java files to get the classes into classes.dex.&lt;&#x2F;p&gt;
&lt;p&gt;Adding code inside MainActivity works in a quite literal way - there is a MainActivity.java template: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;miniquad&#x2F;blob&#x2F;master&#x2F;java&#x2F;MainActivity.java&quot;&gt;MainActivity.java&lt;&#x2F;a&gt;. Each crate based on miniquad can ask the build system to add some lines into &lt;code&gt;&#x2F;&#x2F;% MAIN_ACTIVITY_ON_RESUME&lt;&#x2F;code&gt; or &lt;code&gt;&#x2F;&#x2F;% whatever&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Fortunately Java is not against recurring lines in imprts declaration,&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;java&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-java &quot;&gt;&lt;code class=&quot;language-java&quot; data-lang=&quot;java&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;import &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;android&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;app&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Activity&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;import &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;android&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;app&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Activity&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;import &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;android&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;app&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Activity&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;is totally legit for Java. So each plugin can be independent on each other and add its logic right into the MainActivity, with its own imports and its own initialisation code in Activity OnCreate and so on.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;The plan of building a file dialog crate&lt;&#x2F;strong&gt;&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Make a few .java files with classes helpful for dealing with files&lt;&#x2F;li&gt;
&lt;li&gt;Ask to insert code into MainActivity.java to make some initialization on java side&lt;&#x2F;li&gt;
&lt;li&gt;Call some functions through JNI from our plugin rust code to get the data back&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;how-to-open-a-file-dialog&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#how-to-open-a-file-dialog&quot; aria-label=&quot;Anchor link for: how-to-open-a-file-dialog&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;How to open a file dialog&lt;&#x2F;h2&gt;
&lt;p&gt;This part might be generalized into &amp;quot;How to use Intents on Android&amp;quot;. &lt;&#x2F;p&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.android.com&#x2F;reference&#x2F;android&#x2F;content&#x2F;Intent&quot;&gt;An intent is an abstract description of an operation to be performed. ... An Intent provides a facility for performing late runtime binding between the code in different applications.&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;p&gt;MainActivity has a method, &lt;code&gt;startActivityForResult&lt;&#x2F;code&gt;. This will replace the application&#x27;s activity with a new activity for the intent and later will send the result back into MainActivity.&lt;&#x2F;p&gt;
&lt;p&gt;To simplify getting data from a callback (hmm), the docs &lt;a href=&quot;https:&#x2F;&#x2F;developer.android.com&#x2F;training&#x2F;basics&#x2F;intents&#x2F;result&quot;&gt;suggests&lt;&#x2F;a&gt; to include 88Mb library with 499 Java files. While this is totally possible (check the bluetooth example, it goes this way), let&#x27;s try to avoid this for a little dialog.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;startActivityForResult&lt;&#x2F;code&gt; will send the result into a MainActivity&#x27;s as a MainActivity&#x27;s virtual function. Here ability to patch MainActivity comes in handy: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;example-android-fileopen&#x2F;blob&#x2F;main&#x2F;java&#x2F;MainActivity.java&quot;&gt;add code into MainActivity&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;wrapping-this-into-a-crate&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#wrapping-this-into-a-crate&quot; aria-label=&quot;Anchor link for: wrapping-this-into-a-crate&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Wrapping this into a crate&lt;&#x2F;h2&gt;
&lt;p&gt;The goal here - make a crate that provides a &lt;code&gt;find_file&lt;&#x2F;code&gt; function. This function opens a dialog and returns a bytes of a file content.&lt;&#x2F;p&gt;
&lt;p&gt;To tell cargo where are the java files: 
&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;example-android-fileopen&#x2F;blob&#x2F;main&#x2F;quad.toml&quot;&gt;quad.toml&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;toml&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-toml &quot;&gt;&lt;code class=&quot;language-toml&quot; data-lang=&quot;toml&quot;&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;main_activity_inject &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;java&#x2F;MainActivity.java&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;java_files &lt;&#x2F;span&gt;&lt;span&gt;= [
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;java&#x2F;fileopen&#x2F;FileOpen.java&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Java class responsible for the dialog: &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;example-android-fileopen&#x2F;blob&#x2F;main&#x2F;java&#x2F;fileopen&#x2F;FileOpen.java#L16&quot;&gt;FileOpen.java&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Most java calls look like &lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;let env = android::attach_jni_env();
&lt;&#x2F;span&gt;&lt;span&gt;ndk_utils::call_void_method!(env, &amp;quot;OpenFileDialog&amp;quot;, &amp;quot;()V&amp;quot;);
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Useful links on Rust&amp;lt;-&amp;gt;Java interop:&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;miniquad&#x2F;blob&#x2F;master&#x2F;src&#x2F;native&#x2F;android&#x2F;ndk_utils.rs&quot;&gt;miniquad&#x27;s ndk_utils&lt;&#x2F;a&gt;
&lt;a href=&quot;https:&#x2F;&#x2F;docs.oracle.com&#x2F;javase&#x2F;7&#x2F;docs&#x2F;technotes&#x2F;guides&#x2F;jni&#x2F;spec&#x2F;functions.html&quot;&gt;JNI functions(available in the &amp;quot;env&amp;quot;)&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;using-the-crate&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#using-the-crate&quot; aria-label=&quot;Anchor link for: using-the-crate&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Using the crate&lt;&#x2F;h2&gt;
&lt;p&gt;This part is simple. 
Just include the crate in Cargo.toml: &lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;toml&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-toml &quot;&gt;&lt;code class=&quot;language-toml&quot; data-lang=&quot;toml&quot;&gt;&lt;span&gt;[dependencies]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;fileopen &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;..&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;and use it from any miniquad&#x2F;macroquad project:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;if root_ui().button(None, &amp;quot;Open file&amp;quot;){
&lt;&#x2F;span&gt;&lt;span&gt;    fileopen::find_file(file_data.clone());
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;post-scriptum&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#post-scriptum&quot; aria-label=&quot;Anchor link for: post-scriptum&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Post-scriptum&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;em&gt;Wait is a second, patching java code, calling javac, isn&#x27;t it all horrible hacks?&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;p&gt;&lt;em&gt;Yes it is indeed. Would be so happy to throw it all away! But so far its the easiest way to deal with java I ever seen (from a library user perspective, writing java is horrible). No need to download gigabytes of android studio, no build pipeline complications.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
</content>
	</entry>
	<entry xml:lang="en">
		<title>Publish game on Android with Macroquad</title>
		<published>2021-06-15T09:19:42+00:00</published>
		<updated>2021-06-15T10:19:42+00:00</updated>
		<link rel="alternate" href="https://macroquad.rs/articles/android/" type="text/html"/>
		<id>https://macroquad.rs/articles/android/</id>
		<content type="html">&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;play.google.com&#x2F;store&#x2F;apps&#x2F;details?id=rust.zemeroth&quot;&gt;&lt;img src=&quot;https:&#x2F;&#x2F;macroquad.rs&#x2F;articles&#x2F;android&#x2F;zemeroth.png&quot; alt=&quot;zemeroth&quot; &#x2F;&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;h1 id=&quot;1-introduction&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#1-introduction&quot; aria-label=&quot;Anchor link for: 1-introduction&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;1. Introduction&lt;&#x2F;h1&gt;
&lt;p&gt;This tutorial is based on the experience of publishing &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ozkriff&#x2F;zemeroth&quot;&gt;Zemeroth&lt;&#x2F;a&gt; game on the Google Play Store. The game is now available as open test, &lt;a href=&quot;https:&#x2F;&#x2F;play.google.com&#x2F;store&#x2F;apps&#x2F;details?id=rust.zemeroth&quot;&gt;check it out!&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Topics covered:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Building a macroquad game for android &lt;&#x2F;li&gt;
&lt;li&gt;Common pitfalls and debugging tips&lt;&#x2F;li&gt;
&lt;li&gt;Setting up and uploading an APK to a Google Play&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h1 id=&quot;2-setting-up-your-environment&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#2-setting-up-your-environment&quot; aria-label=&quot;Anchor link for: 2-setting-up-your-environment&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;2. Setting up your Environment&lt;&#x2F;h1&gt;
&lt;h2 id=&quot;a-docker-way&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#a-docker-way&quot; aria-label=&quot;Anchor link for: a-docker-way&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;A docker way&lt;&#x2F;h2&gt;
&lt;p&gt;On the machine with docker pulling all the NDK dependencies is as simple as&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;docker pull not-fl3&#x2F;cargo-apk
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Docker is a recommended way to build macroquad&#x27;s game for Android. &lt;&#x2F;p&gt;
&lt;h3 id=&quot;building-an-apk-a-docker-way&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#building-an-apk-a-docker-way&quot; aria-label=&quot;Anchor link for: building-an-apk-a-docker-way&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Building an APK, a docker way&lt;&#x2F;h3&gt;
&lt;p&gt;APK may be made with just one command:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;docker run 
&lt;&#x2F;span&gt;&lt;span&gt;  --rm 
&lt;&#x2F;span&gt;&lt;span&gt;  -v $(pwd):&#x2F;root&#x2F;src 
&lt;&#x2F;span&gt;&lt;span&gt;  -w &#x2F;root&#x2F;src 
&lt;&#x2F;span&gt;&lt;span&gt;  notfl3&#x2F;cargo-apk cargo quad-apk build --release
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This will produce an apk in &lt;code&gt;target&#x2F;android-artifacts&#x2F;release&#x2F;apk&lt;&#x2F;code&gt;. &lt;&#x2F;p&gt;
&lt;p&gt;However this may take quite a while - each docker invocation will do a clean build for all 3 android targets.&lt;&#x2F;p&gt;
&lt;p&gt;One way to make it a little bit faster: add &lt;code&gt; -v &#x2F;tmp&#x2F;registry\&amp;quot;:&#x2F;usr&#x2F;local&#x2F;cargo&#x2F;registry\&amp;quot;&lt;&#x2F;code&gt; to a docker command. This will tell docker to use &lt;code&gt;&#x2F;tmp&#x2F;registry&lt;&#x2F;code&gt; on the host machine for cargo&#x27;s registry, therefore docker will not download all the dependencies on each build.&lt;&#x2F;p&gt;
&lt;p&gt;Another possibility: run docker interactively and invoke build command in the same container for each build.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;docker run 
&lt;&#x2F;span&gt;&lt;span&gt;  --rm 
&lt;&#x2F;span&gt;&lt;span&gt;  -v $(pwd):&#x2F;root&#x2F;src 
&lt;&#x2F;span&gt;&lt;span&gt;  -w &#x2F;root&#x2F;src 
&lt;&#x2F;span&gt;&lt;span&gt;  -it notfl3&#x2F;cargo-apk &#x2F;bin&#x2F;bash
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;and later, in the docker&#x27;s bash: &lt;code&gt;cargo quad-apk build --release&lt;&#x2F;code&gt;. And use the same command for each iteration.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-manual-way&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#a-manual-way&quot; aria-label=&quot;Anchor link for: a-manual-way&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;A manual way&lt;&#x2F;h2&gt;
&lt;p&gt;Docker simplify the process of installing android-sdk and android-ndk. But, sometimes, it may be more convinient to use all native build pipeline. 
While this is not really recommended, this path is included to a tutorial for better illustrating what exactly is going on in the container.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;installing-pre-requisites&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#installing-pre-requisites&quot; aria-label=&quot;Anchor link for: installing-pre-requisites&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Installing pre-requisites:&lt;&#x2F;h3&gt;
&lt;p&gt;Exact commands and pathes may depend on the host OS. Here linux commands are used, but on all the other OSes the idea should be very similar.&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;JRE or JDK&lt;&#x2F;p&gt;
&lt;p&gt;This step highly depends on the OS, for ubuntu: &lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;sudo apt-get install openjdk-8-jdk
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;Rust android&lt;&#x2F;p&gt;
&lt;p&gt;Assuming rustup&#x27;s rust installation:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;rustup target add armv7-linux-androideabi
&lt;&#x2F;span&gt;&lt;span&gt;rustup target add aarch64-linux-android
&lt;&#x2F;span&gt;&lt;span&gt;rustup target add i686-linux-android
&lt;&#x2F;span&gt;&lt;span&gt;rustup target add x86_64-linux-android
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;Android SDK&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;# create a folder for all the android pre-requisites stuff
&lt;&#x2F;span&gt;&lt;span&gt;mkdir &#x2F;this&#x2F;may&#x2F;be&#x2F;any&#x2F;path&#x2F;android
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;cd android
&lt;&#x2F;span&gt;&lt;span&gt;wget -q https:&#x2F;&#x2F;dl.google.com&#x2F;android&#x2F;repository&#x2F;sdk-tools-linux-4333796.zip
&lt;&#x2F;span&gt;&lt;span&gt;unzip -q sdk-tools-linux-4333796.zip
&lt;&#x2F;span&gt;&lt;span&gt;rm sdk-tools-linux-4333796.zip
&lt;&#x2F;span&gt;&lt;span&gt;tools&#x2F;bind&#x2F;sdkmanager &amp;quot;platform-tools&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;tools&#x2F;bin&#x2F;sdkmanager &amp;quot;platforms;android-29&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;tools&#x2F;bin&#x2F;sdkmanager &amp;quot;build-tools;29.0.0&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;tools&#x2F;bin&#x2F;sdkmanager --update
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;Android NDK&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;# go to the same dir created for android-sdk
&lt;&#x2F;span&gt;&lt;span&gt;cd &#x2F;path&#x2F;from&#x2F;previous&#x2F;step&#x2F;android
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;wget -q https:&#x2F;&#x2F;dl.google.com&#x2F;android&#x2F;repository&#x2F;android-ndk-r25b-linux.zip
&lt;&#x2F;span&gt;&lt;span&gt;unzip -q android-ndk-r25b-linux.zip
&lt;&#x2F;span&gt;&lt;span&gt;rm android-ndk-r25-linux-x86_64.zip
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;&#x2F;li&gt;
&lt;li&gt;
&lt;p&gt;Cargo APK&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;cargo-quad-apk&lt;&#x2F;code&gt; is a cargo extension, allowing&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;cargo install cargo-quad-apk
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h3 id=&quot;building-an-apk-a-manual-way&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#building-an-apk-a-manual-way&quot; aria-label=&quot;Anchor link for: building-an-apk-a-manual-way&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Building an APK, a manual way&lt;&#x2F;h3&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;export ANDROID_HOME=&#x2F;path&#x2F;from&#x2F;previous&#x2F;step&#x2F;android
&lt;&#x2F;span&gt;&lt;span&gt;export NDK_HOME=&#x2F;path&#x2F;from&#x2F;previous&#x2F;step&#x2F;android&#x2F;android-ndk-r25
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;# for a debug build
&lt;&#x2F;span&gt;&lt;span&gt;cargo quad-apk build
&lt;&#x2F;span&gt;&lt;span&gt;# for a release build
&lt;&#x2F;span&gt;&lt;span&gt;cargo quad-apk build --release
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;An apk will be in &lt;code&gt;target&#x2F;android-artifacts&#x2F;debug&#x2F;apk&lt;&#x2F;code&gt; or &lt;code&gt;target&#x2F;android-artifacts&#x2F;release&#x2F;apk&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;3-fine-tuning-the-game-for-android&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#3-fine-tuning-the-game-for-android&quot; aria-label=&quot;Anchor link for: 3-fine-tuning-the-game-for-android&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;3. Fine tuning the game for android&lt;&#x2F;h1&gt;
&lt;h2 id=&quot;targeting-api-level-31&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#targeting-api-level-31&quot; aria-label=&quot;Anchor link for: targeting-api-level-31&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Targeting API Level &amp;gt;= 31&lt;&#x2F;h2&gt;
&lt;p&gt;You have to add this to your Cargo.toml&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;[package.metadata.android.activity_attributes]
&lt;&#x2F;span&gt;&lt;span&gt;&amp;quot;android:exported&amp;quot; =  &amp;quot;true&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;assets-folder&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#assets-folder&quot; aria-label=&quot;Anchor link for: assets-folder&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Assets folder&lt;&#x2F;h2&gt;
&lt;p&gt;Assuming following project structure: &lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;.
&lt;&#x2F;span&gt;&lt;span&gt;â”œâ”€â”€ assets
&lt;&#x2F;span&gt;&lt;span&gt;â”œâ”€â”€ â””â”€â”€ nice_texture.png
&lt;&#x2F;span&gt;&lt;span&gt;â”œâ”€â”€ src
&lt;&#x2F;span&gt;&lt;span&gt;â”œâ”€â”€ â””â”€â”€ main.rs
&lt;&#x2F;span&gt;&lt;span&gt;â””â”€â”€ Cargo.toml
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;To include assets folder to an APK, add this to your Cargo.toml:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;ini&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-ini &quot;&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;[package.metadata.android]
&lt;&#x2F;span&gt;&lt;span&gt;assets &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;assets&#x2F;&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Later on texture may be loaded with &lt;code&gt;load_texture(&amp;quot;nice_texture.png&amp;quot;)&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;However, on PC, usually, the load_texture call will look like &lt;code&gt;load_texture(&amp;quot;assets&#x2F;nice_texture.png&amp;quot;)&lt;&#x2F;code&gt; - the assets folder itself is a part of the path.&lt;&#x2F;p&gt;
&lt;p&gt;To fix it and use uniforms path between android and PC &lt;a href=&quot;https:&#x2F;&#x2F;docs.rs&#x2F;macroquad&#x2F;0.3.6&#x2F;macroquad&#x2F;file&#x2F;fn.set_pc_assets_folder.html&quot;&gt;set_pc_assets_folder&lt;&#x2F;a&gt; may help.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;macroquad::file::set_pc_assets_folder(&amp;quot;assets&amp;quot;);
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now its &lt;code&gt;load_texture(&amp;quot;nice_texture.png&amp;quot;)&lt;&#x2F;code&gt; on both platforms.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;high-dpi&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#high-dpi&quot; aria-label=&quot;Anchor link for: high-dpi&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;High-dpi&lt;&#x2F;h2&gt;
&lt;img src=&quot;densities-phone_2x.png&quot;  width=&quot;300px&quot;&#x2F;&gt;
&lt;p&gt;&lt;em&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.android.com&#x2F;training&#x2F;multiscreen&#x2F;screendensities&quot;&gt;Image source&lt;&#x2F;a&gt;&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Android devices have significant pixel dencity difference. 
By default, android tries to emulate a low-density display on a high-density pixel display.&lt;&#x2F;p&gt;
&lt;p&gt;This means that &lt;code&gt;screen_width()&#x2F;screen_height()&lt;&#x2F;code&gt; may give a value way lower than the actual screen pixel resolution, but later on android will automatically upscale the viewport.&lt;&#x2F;p&gt;
&lt;p&gt;This may be OK - smaller viewport means better FPS, but if android&#x27;s upscale is not required - the game should tell android to support &amp;quot;high-dpi&amp;quot; screens.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;window_conf&lt;&#x2F;span&gt;&lt;span&gt;() -&amp;gt; window::Conf {
&lt;&#x2F;span&gt;&lt;span&gt;    window::Conf {
&lt;&#x2F;span&gt;&lt;span&gt;        window_title: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Zemeroth&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;to_owned&lt;&#x2F;span&gt;&lt;span&gt;(),
&lt;&#x2F;span&gt;&lt;span&gt;        high_dpi: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;true&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;..&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Default&lt;&#x2F;span&gt;&lt;span&gt;::default()
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;#[macroquad::main(window_conf)]
&lt;&#x2F;span&gt;&lt;span&gt;async &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;main&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;screen-orientation&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#screen-orientation&quot; aria-label=&quot;Anchor link for: screen-orientation&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Screen orientation&lt;&#x2F;h2&gt;
&lt;p&gt;By default Macroquad games are fullscreen and allows any screen locations.
To limit possible screen orientations add this to your Cargo.toml: &lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;ini&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-ini &quot;&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;[package.metadata.android.activity_attributes]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;android:screenOrientation&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;userLandscape&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;icon&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#icon&quot; aria-label=&quot;Anchor link for: icon&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Icon&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;img src=&quot;https:&#x2F;&#x2F;macroquad.rs&#x2F;articles&#x2F;android&#x2F;icon.jpg&quot; alt=&quot;icon&quot; &#x2F;&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Application icon lives in an &amp;quot;resources&amp;quot; - special section in APK.
To include &amp;quot;res&amp;quot; folder to an APK:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;ini&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-ini &quot;&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;[package.metadata.android]
&lt;&#x2F;span&gt;&lt;span&gt;res &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;android_res&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;icon &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;@mipmap&#x2F;ic_launcher&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And the icon itself for different DPI may look something like this:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;android_res&#x2F;
&lt;&#x2F;span&gt;&lt;span&gt;â”œâ”€â”€ mipmap-hdpi
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â””â”€â”€ ic_launcher.png
&lt;&#x2F;span&gt;&lt;span&gt;â”œâ”€â”€ mipmap-mdpi
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â””â”€â”€ ic_launcher.png
&lt;&#x2F;span&gt;&lt;span&gt;â”œâ”€â”€ mipmap-xhdpi
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â””â”€â”€ ic_launcher.png
&lt;&#x2F;span&gt;&lt;span&gt;â”œâ”€â”€ mipmap-xxhdpi
&lt;&#x2F;span&gt;&lt;span&gt;â”‚Â Â  â””â”€â”€ ic_launcher.png
&lt;&#x2F;span&gt;&lt;span&gt;â””â”€â”€ mipmap-xxxhdpi
&lt;&#x2F;span&gt;&lt;span&gt;    â””â”€â”€ ic_launcher.png
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Icons for each size certainly may be generated manually. For this tutorial 
&lt;a href=&quot;http:&#x2F;&#x2F;romannurik.github.io&#x2F;AndroidAssetStudio&#x2F;icons-launcher.html&quot;&gt;http:&#x2F;&#x2F;romannurik.github.io&#x2F;AndroidAssetStudio&#x2F;icons-launcher.html&lt;&#x2F;a&gt; was used, worked pretty good.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;debug-logs&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#debug-logs&quot; aria-label=&quot;Anchor link for: debug-logs&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Debug logs&lt;&#x2F;h2&gt;
&lt;p&gt;All the &lt;code&gt;warn!&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;info!&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;debug!&lt;&#x2F;code&gt; macroquad&#x27;s messages goes into android system messages. To access android&#x27;s system messages there is &lt;code&gt;adb logcat&lt;&#x2F;code&gt; command. There are various way to filter &lt;code&gt;adb logcat&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;filter-adb-logcat-by-tag&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#filter-adb-logcat-by-tag&quot; aria-label=&quot;Anchor link for: filter-adb-logcat-by-tag&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Filter &lt;code&gt;adb logcat&lt;&#x2F;code&gt; by tag&lt;&#x2F;h3&gt;
&lt;p&gt;Filter by tag will show only messages posted by macroquad&#x27;s &lt;code&gt;warn!&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;info!&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;debug!&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;adb logcat -v brief SAPP:V &amp;quot;*:S&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;code&gt;-v brief&lt;&#x2F;code&gt; will save a little bit of screen space, hiding some log metadata.&lt;&#x2F;p&gt;
&lt;p&gt;Arguments after &lt;code&gt;adb logcat&lt;&#x2F;code&gt; are filter specification.&lt;&#x2F;p&gt;
&lt;p&gt;SAPP:V - For messages with tag SAPP V(verbose) filter will be applied. All the SAPP messages will be in the output.
*:S - For all the other tags S(silent) filter will be applied. All the other messages will be filtered out.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;filter-by-pid&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#filter-by-pid&quot; aria-label=&quot;Anchor link for: filter-by-pid&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Filter by PID&lt;&#x2F;h3&gt;
&lt;p&gt;Sometimes application produced some extra system messages. It may be some system warnings or some unhandled native libraries problems. But those messages may be filtered out when &lt;code&gt;adb logcat&lt;&#x2F;code&gt; is filtered by tag.&lt;&#x2F;p&gt;
&lt;p&gt;PID is a process id, and filtering by PID will give all the application output, with any tag.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;# Find out PID
&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt; adb shell pidof -s rust.CRATENAME
&lt;&#x2F;span&gt;&lt;span&gt;30243
&lt;&#x2F;span&gt;&lt;span&gt;# Get all the messages from a given PID
&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;adb shell pidof -s 30243
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Depending on the command processor those to commands may be usually reduced to something like&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;adb logcat --pid=$(adb shell pidof -s rust.CRATENAME)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;4-signing-the-apk&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#4-signing-the-apk&quot; aria-label=&quot;Anchor link for: 4-signing-the-apk&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;4. Signing the APK&lt;&#x2F;h1&gt;
&lt;p&gt;By default, &lt;code&gt;cargo quad-apk&lt;&#x2F;code&gt; generates debug kestore file and is signing up an APK with a debug key. This allows the APK to be installed locally, but is not enough for the Google Play.&lt;&#x2F;p&gt;
&lt;p&gt;For the Play Store non-debug keystore file is required, and this file should be uploaded to the Play Console to verify developer identity. &lt;&#x2F;p&gt;
&lt;p&gt;To generate the key &lt;code&gt;keytool&lt;&#x2F;code&gt; is required. &lt;code&gt;keytool&lt;&#x2F;code&gt; is a part of a &lt;code&gt;java&lt;&#x2F;code&gt; ditribution and is being shipped with &lt;code&gt;openjdk&lt;&#x2F;code&gt;.
To sign the the APK &lt;code&gt;apksigner&lt;&#x2F;code&gt; is requires. &lt;code&gt;apksigner&lt;&#x2F;code&gt; is a part of Android SDK. &lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;keytool -v -genkey -keystore mygame.keystore -alias mygame -keyalg RSA -validity 10000
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now all the pre-requisites are fullfilled and the key is ready to be used for a release build.&lt;&#x2F;p&gt;
&lt;p&gt;First, tell &lt;code&gt;cargo-apk&lt;&#x2F;code&gt; to stop signing the build with debug keystore:
&lt;code&gt;cargo quad-apk build --release --nosign&lt;&#x2F;code&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Than sign the APK with a non-debug keystore file:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;apksigner sign --ks mygame.keystore my-app.apk --ks-key-alias alias_name
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;It may be verified with&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;apksigner verify my-app.apk
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.android.com&#x2F;studio&#x2F;publish&#x2F;app-signing.html#signing-manually&quot;&gt;The official documentation on signing can be found here.&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;note-how-to-get-keytool-apksigner-with-docker&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#note-how-to-get-keytool-apksigner-with-docker&quot; aria-label=&quot;Anchor link for: note-how-to-get-keytool-apksigner-with-docker&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;NOTE: how to get &lt;code&gt;keytool&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;apksigner&lt;&#x2F;code&gt; with docker&lt;&#x2F;h2&gt;
&lt;p&gt;Assuming android keystore lives in ~&#x2F;.android and .apk to sign lives in current working directory: &lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;docker run --rm 
&lt;&#x2F;span&gt;&lt;span&gt;    -v (pwd):&#x2F;root&#x2F;src  
&lt;&#x2F;span&gt;&lt;span&gt;    -v(&#x2F;home&#x2F;USER&#x2F;.android):&#x2F;root&#x2F;.android_secrets 
&lt;&#x2F;span&gt;&lt;span&gt;    -w &#x2F;root&#x2F;src -it notfl3&#x2F;cargo-apk &#x2F;bin&#x2F;bash
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This command will gives a bash session with current directory mounted to &lt;code&gt;&#x2F;root&#x2F;src&lt;&#x2F;code&gt; and .android mounted to &lt;code&gt;&#x2F;root&#x2F;.android_secrets&lt;&#x2F;code&gt;
And inside the container APK may be signed with&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;apksigner sign --ks my.keystore my-app.apk --ks-key-alias alias_name
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;android-targets&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#android-targets&quot; aria-label=&quot;Anchor link for: android-targets&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Android targets&lt;&#x2F;h2&gt;
&lt;p&gt;By default &lt;code&gt;cargo quad-apk&lt;&#x2F;code&gt; is building an APK for 3 different platforms. 
To comply Google Play requirements and get all the platforms:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;ini&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-ini &quot;&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;[package.metadata.android]
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;..
&lt;&#x2F;span&gt;&lt;span&gt;build_targets &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; [ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;armv7-linux-androideabi&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;aarch64-linux-android&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;i686-linux-android&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;x86_64-linux-android&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; ]
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;To reduce build time while debugging - pick one for a testing device in use:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;ini&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-ini &quot;&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;[package.metadata.android]
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;..
&lt;&#x2F;span&gt;&lt;span&gt;build_targets &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; [ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;armv7-linux-androideabi&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt; ]
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;google-play-versioning&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#google-play-versioning&quot; aria-label=&quot;Anchor link for: google-play-versioning&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Google Play versioning&lt;&#x2F;h2&gt;
&lt;p&gt;Google play have its own versioning mechanism for uploaded APKs.
Each APK for google play should have unique &lt;code&gt;version_code&lt;&#x2F;code&gt;.
Otherwise google developer console will end up with &lt;code&gt;Version code 1 has already been used. Try another version code.&amp;quot;&lt;&#x2F;code&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;To set &lt;code&gt;version_code&lt;&#x2F;code&gt; from an app Cargo.toml:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;ini&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-ini &quot;&gt;&lt;code class=&quot;language-ini&quot; data-lang=&quot;ini&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;[package.metadata.android]
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;..
&lt;&#x2F;span&gt;&lt;span&gt;version_code &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;2
&lt;&#x2F;span&gt;&lt;span&gt;version_name &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Version Name&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.android.com&#x2F;studio&#x2F;publish&#x2F;versioning&quot;&gt;The official documentation on versioning can be found here.&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;preview-assets-for-a-store-page&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#preview-assets-for-a-store-page&quot; aria-label=&quot;Anchor link for: preview-assets-for-a-store-page&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Preview assets for a store page&lt;&#x2F;h2&gt;
&lt;p&gt;To submit your game for a google review and do an open test&#x2F;release - the Play Store page should be filled setted up - screenshots&#x2F;descriptions should be uploaded. Lots of data will be marked as (*)required, however, the real minimal subset of game graphics to upload is:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;512x512 icon&lt;&#x2F;li&gt;
&lt;li&gt;1024x500 banner&lt;&#x2F;li&gt;
&lt;li&gt;two 16:9 screenshots&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;developer.android.com&#x2F;studio&#x2F;publish&#x2F;versioning&quot;&gt;Useful article on preview assets.&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;internal-test-open-test-and-release&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#internal-test-open-test-and-release&quot; aria-label=&quot;Anchor link for: internal-test-open-test-and-release&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Internal test, open test and release&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;em&gt;Difference between an internal, closed, and open test?&lt;&#x2F;em&gt;
&lt;em&gt;You can create releases on three testing tracks before you release your app to production.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;p&gt;&lt;em&gt;Internal testing: Create an internal testing release to quickly distribute your app to up to 100 testers for initial quality assurance checks.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Do not require setted up store page and do not require a review. Helps with ensuring that signing process actually worked, build is really uploaded. Also allows to add testers by email.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;em&gt;Closed testing: Create a closed testing release to test pre-release versions of your app with a wider set of testers to gather more targeted feedback.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Almost an open test, but requires adding tester&#x27;s email.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;em&gt;Open testing: Create an open testing release to run a test with a large group and surface your app&#x27;s test version on Google Play. If you run an open test, anyone can join your testing program and submit private feedback to you.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Almost a release, page is publicly available, no additional actions from testers required to install the game.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;support.google.com&#x2F;googleplay&#x2F;android-developer&#x2F;answer&#x2F;9845334?hl=en&quot;&gt;More info on testing tracks can be found here.&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
</content>
	</entry>
	<entry xml:lang="en">
		<title>Making an online multiplayer game in Rust with Nakama</title>
		<published>2021-05-01T09:19:42+00:00</published>
		<updated>2021-05-01T09:19:42+00:00</updated>
		<link rel="alternate" href="https://macroquad.rs/articles/fish-tutorial/" type="text/html"/>
		<id>https://macroquad.rs/articles/fish-tutorial/</id>
		<content type="html">&lt;img src=&quot;&#x2F;fishgame_tutorial&#x2F;title.gif&quot;  width=&quot;100%&quot;&#x2F;&gt;
&lt;p&gt;Fish Game is a 2-4 player online game built in the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;macroquad&#x2F;&quot;&gt;Macroquad&lt;&#x2F;a&gt; game engine and the &lt;a href=&quot;https:&#x2F;&#x2F;www.rust-lang.org&#x2F;&quot;&gt;Rust&lt;&#x2F;a&gt; programming language. The game was created as a demonstration of &lt;a href=&quot;https:&#x2F;&#x2F;heroiclabs.com&#x2F;&quot;&gt;Nakama&lt;&#x2F;a&gt;, an open-source scalable game server.&lt;&#x2F;p&gt;
&lt;p&gt;As you can see, Fish Game is a frenetic platformer arena starring murderous fish - the last fish standing wins! The game design is heavily inspired by the excellent &lt;a href=&quot;https:&#x2F;&#x2F;store.steampowered.com&#x2F;app&#x2F;312530&#x2F;Duck_Game&#x2F;&quot;&gt;Duck Game&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The game is playable &lt;a href=&quot;https:&#x2F;&#x2F;fedorgames.itch.io&#x2F;fish-game?secret=UAVcggHn332a&quot;&gt;online on itch.io&lt;&#x2F;a&gt; and the Windows&#x2F;Linux&#x2F;Mac native version may be built from &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;heroiclabs&#x2F;fishgame-macroquad&quot;&gt;the source&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;In this tutorial, weâ€™re going to walk through each part of the code that interacts with Nakama to cover all the principles and APIs that you need to know to create your own online multiplayer game with Macroquad and Nakama.&lt;&#x2F;p&gt;
&lt;p&gt;Weâ€™ll touch on the following Nakama features:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;User authentication&lt;&#x2F;li&gt;
&lt;li&gt;Matchmaking&lt;&#x2F;li&gt;
&lt;li&gt;Realtime Multiplayer&lt;&#x2F;li&gt;
&lt;li&gt;Leaderboards&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;This tutorial will briefly cover how to create a game with Macroquad. Afterward, it will focus on Nakama integration.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;making-a-platformer-game&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#making-a-platformer-game&quot; aria-label=&quot;Anchor link for: making-a-platformer-game&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Making a platformer game&lt;&#x2F;h1&gt;
&lt;p&gt;This part of the tutorial will explain how to create a single-player platformer game in Rust, starting with setting up macroquad. By the end of this section, we will have created a simple but fully functional platformer.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;setting-up-macroquad&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#setting-up-macroquad&quot; aria-label=&quot;Anchor link for: setting-up-macroquad&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Setting up macroquad&lt;&#x2F;h2&gt;
&lt;p&gt;Start an empty Rust project:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; cargo init --bin fishgame
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Run it: &lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; cd fishgame
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;&lt;&#x2F;span&gt;&lt;span&gt; cargo run 
&lt;&#x2F;span&gt;&lt;span&gt;     Running `target&#x2F;debug&#x2F;fishgame`
&lt;&#x2F;span&gt;&lt;span&gt;Hello, world!
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Open &lt;code&gt;Cargo.toml&lt;&#x2F;code&gt; and add macroquad as a dependency:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;toml&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-toml &quot;&gt;&lt;code class=&quot;language-toml&quot; data-lang=&quot;toml&quot;&gt;&lt;span&gt;[package]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;name &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;fishgame&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;background-color:#f5f5f5;font-weight:bold;color:#b52a1d;&quot;&gt;...&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[dependencies]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;macroquad &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;0.3&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Open &lt;code&gt;src&#x2F;main.rs&lt;&#x2F;code&gt; and add some macroquad drawing code to check that everything works (took this from &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;macroquad&#x2F;tree&#x2F;master&#x2F;examples&quot;&gt;macroquad examples&lt;&#x2F;a&gt;):&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;src&#x2F;main.rs&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;use &lt;&#x2F;span&gt;&lt;span&gt;macroquad::prelude::&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;#[macroquad::main(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;BasicShapes&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)]
&lt;&#x2F;span&gt;&lt;span&gt;async &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;main&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;loop &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;clear_background&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;RED&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;draw_line&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;40.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;40.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;100.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;200.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;15.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;BLUE&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;draw_rectangle&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;screen_width&lt;&#x2F;span&gt;&lt;span&gt;() &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&#x2F; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;2.0 &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;60.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;100.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;120.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;60.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;GREEN&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;draw_circle&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;screen_width&lt;&#x2F;span&gt;&lt;span&gt;() &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;30.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;screen_height&lt;&#x2F;span&gt;&lt;span&gt;() &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;30.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;15.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;YELLOW&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;draw_text&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;IT WORKS!&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;20.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;20.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;30.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;DARKGRAY&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;next_frame&lt;&#x2F;span&gt;&lt;span&gt;().await
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;&amp;gt; cargo run
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;img src=&quot;&#x2F;fishgame_tutorial&#x2F;itworks.png&quot;  width=&quot;100%&quot;&#x2F;&gt;
&lt;p&gt;If we got a window with some shapes: All good, the project is set up correctly. Now it&#x27;s time to draw more shapes to make it look like a game.&lt;&#x2F;p&gt;
&lt;p&gt;If instead of a window, we have some errors: Maybe some native dependency is missing. Most likely, it is one of these: &lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;bash&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-bash &quot;&gt;&lt;code class=&quot;language-bash&quot; data-lang=&quot;bash&quot;&gt;&lt;span&gt;apt install libx11-dev libxi-dev libgl1-mesa-dev
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;For more details, check the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;macroquad&#x2F;#building-instructions&quot;&gt;build instructions&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;making-game-levels&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#making-game-levels&quot; aria-label=&quot;Anchor link for: making-game-levels&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Making game levels&lt;&#x2F;h2&gt;
&lt;p&gt;The easiest way to do some 2D-level design with macroquad is with the free tiles editor &lt;a href=&quot;https:&#x2F;&#x2F;www.mapeditor.org&quot;&gt;Tiled&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;img src=&quot;&#x2F;fishgame_tutorial&#x2F;tiled.png&quot;  width=&quot;100%&quot;&#x2F;&gt;
&lt;p&gt;&lt;em&gt;Tiled with &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;heroiclabs&#x2F;fishgame-macroquad&#x2F;blob&#x2F;master&#x2F;assets&#x2F;map.json&quot;&gt;Fish Game&#x27;s level&lt;&#x2F;a&gt;&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;p&gt;We have a &lt;a href=&quot;https:&#x2F;&#x2F;crates.io&#x2F;crates&#x2F;macroquad-tiled&quot;&gt;crate&lt;&#x2F;a&gt; for reading tiled data in macroquad. 
&lt;code&gt;our Cargo.toml&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;toml&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-toml &quot;&gt;&lt;code class=&quot;language-toml&quot; data-lang=&quot;toml&quot;&gt;&lt;span style=&quot;background-color:#f5f5f5;font-weight:bold;color:#b52a1d;&quot;&gt;...&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;[dependencies]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;macroquad &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;0.3&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;# the new dependency, macroquad-tiled crate:
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;macroquad-tiled &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;0.1&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Then load the Tiled map to macroquad and draw a level:&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;src&#x2F;main.rs&lt;&#x2F;code&gt;, all assets are in &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;heroiclabs&#x2F;fishgame-macroquad&#x2F;tree&#x2F;master&#x2F;assets&quot;&gt;the Fish Game repo&lt;&#x2F;a&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;use &lt;&#x2F;span&gt;&lt;span&gt;macroquad::prelude::&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;use&lt;&#x2F;span&gt;&lt;span&gt; macroquad_tiled &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as&lt;&#x2F;span&gt;&lt;span&gt; tiled;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;#[macroquad::main(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Fishgame&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)]
&lt;&#x2F;span&gt;&lt;span&gt;async &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;main&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; tileset &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;load_texture&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;assets&#x2F;tileset.png&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;).await;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; decorations &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;load_texture&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;assets&#x2F;decorations1.png&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;).await;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; tiled_map_json &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;load_string&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;assets&#x2F;map.json&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;).await.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; tiled_map &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;tiled::load_map(
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;tiled_map_json,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;[(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;tileset.png&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, tileset), (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;decorations1.png&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, decorations)],
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;[],
&lt;&#x2F;span&gt;&lt;span&gt;    )
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;loop &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;clear_background&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;BLACK&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;        tiled_map.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;draw_tiles&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; The name of the layer in assets&#x2F;map.json
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;main layer&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;            Rect::new(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;screen_width&lt;&#x2F;span&gt;&lt;span&gt;(), &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;screen_height&lt;&#x2F;span&gt;&lt;span&gt;()),
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;None&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        );
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;next_frame&lt;&#x2F;span&gt;&lt;span&gt;().await;
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;img src=&quot;&#x2F;fishgame_tutorial&#x2F;background.png&quot;  width=&quot;100%&quot;&#x2F;&gt;
&lt;p&gt;Now we have a level background. For a more polished game, it would be reasonable to invest some time into a more complicated camera, window handling, etc.
All of those are implemented in the final Fish Game but will be skipped in the tutorial to get started with Nakama faster.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;character-physics&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#character-physics&quot; aria-label=&quot;Anchor link for: character-physics&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Character physics&lt;&#x2F;h2&gt;
&lt;p&gt;Add a character into the level from the previous chapter:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; whale &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;load_texture&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;assets&#x2F;Whale&#x2F;Whale(76x66)(Orange).png&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;).await;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; for simplicity lets give our world fixed size
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; width &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;700.&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; height &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;500.&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;loop &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    tiled_map.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;draw_tiles&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; The name of the layer in assets&#x2F;map.json
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;main layer&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        Rect::new(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.0&lt;&#x2F;span&gt;&lt;span&gt;, width, height),
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;None&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;    );
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;draw_texture_ex&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;        whale,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;WHITE&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        DrawTextureParams {
&lt;&#x2F;span&gt;&lt;span&gt;            source: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Some&lt;&#x2F;span&gt;&lt;span&gt;(Rect::new(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;76.&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;66.&lt;&#x2F;span&gt;&lt;span&gt;)),
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;..&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Default&lt;&#x2F;span&gt;&lt;span&gt;::default()
&lt;&#x2F;span&gt;&lt;span&gt;        },
&lt;&#x2F;span&gt;&lt;span&gt;    );
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;img src=&quot;&#x2F;fishgame_tutorial&#x2F;character.png&quot;  width=&quot;100%&quot;&#x2F;&gt;
&lt;p&gt;Now we have a character and a level. The next step is to allow the user to move the character.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span&gt; fish_pos &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;vec2&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;200.&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;100.&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;loop &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;is_key_down&lt;&#x2F;span&gt;&lt;span&gt;(KeyCode::Right) {
&lt;&#x2F;span&gt;&lt;span&gt;        fish_pos.x &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;+= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;1.0&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;is_key_down&lt;&#x2F;span&gt;&lt;span&gt;(KeyCode::Left) {
&lt;&#x2F;span&gt;&lt;span&gt;        fish_pos.x &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;-= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;1.0&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; fish_bottom_point &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;vec2&lt;&#x2F;span&gt;&lt;span&gt;(fish_pos.x &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;+ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;76. &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&#x2F; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;2.&lt;&#x2F;span&gt;&lt;span&gt;, fish_pos.y &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;+ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;66.&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; fish_tile &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;vec2&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;        fish_bottom_point.x &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt; width &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt; tiled_map.raw_tiled_map.width &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as f32&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        fish_bottom_point.y &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&#x2F;&lt;&#x2F;span&gt;&lt;span&gt; height &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt; tiled_map.raw_tiled_map.height &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as f32&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;    );
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; tiled_map
&lt;&#x2F;span&gt;&lt;span&gt;        .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;get_tile&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;main layer&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, fish_tile.x &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as u32&lt;&#x2F;span&gt;&lt;span&gt;, fish_tile.y &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as u32&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;        .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;is_none&lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;    {
&lt;&#x2F;span&gt;&lt;span&gt;        fish_pos.y &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;+= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;2.0&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;img src=&quot;&#x2F;fishgame_tutorial&#x2F;character_moving.gif&quot;  width=&quot;100%&quot;&#x2F;&gt;
&lt;p&gt;There are lots hard-coded corner cases to take into account, but putting all of this together gives us a complete platformer character mechanic.&lt;&#x2F;p&gt;
&lt;p&gt;There is a crate with platformer physics implementation based on the brilliant &lt;a href=&quot;https:&#x2F;&#x2F;maddythorson.medium.com&#x2F;celeste-and-towerfall-physics-d24bd2ae0fc5&quot;&gt;article on Celeste and Towerfall physics&lt;&#x2F;a&gt;: &lt;a href=&quot;https:&#x2F;&#x2F;crates.io&#x2F;crates&#x2F;macroquad-platformer&quot;&gt;macroquad-platformer&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;Cargo.toml&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;toml&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-toml &quot;&gt;&lt;code class=&quot;language-toml&quot; data-lang=&quot;toml&quot;&gt;&lt;span&gt;[dependencies]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;macroquad &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;0.3&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;macroquad-tiled &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;0.1&amp;quot;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;macroquad-platformer &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;0.1&amp;quot;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;With the new crate involved, the code will look like the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;macroquad&#x2F;blob&#x2F;master&#x2F;examples&#x2F;platformer.rs&quot;&gt;platformer example&lt;&#x2F;a&gt;. &lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span&gt; world &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;World::new();
&lt;&#x2F;span&gt;&lt;span&gt;world.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;add_static_tiled_layer&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;    static_colliders,
&lt;&#x2F;span&gt;&lt;span&gt;    tiled_map.raw_tiled_map.tilewidth &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as f32&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;    tiled_map.raw_tiled_map.tileheight &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as f32&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;    tiled_map.raw_tiled_map.width &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as _&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span&gt; player &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; world.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;add_actor&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;vec2&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;200.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;100.0&lt;&#x2F;span&gt;&lt;span&gt;), &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;36&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;66&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;loop &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; now instead of moving player directly
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; we do it through a crate
&lt;&#x2F;span&gt;&lt;span&gt;    world.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;move_h&lt;&#x2F;span&gt;&lt;span&gt;(player, speed.x &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;get_frame_time&lt;&#x2F;span&gt;&lt;span&gt;());
&lt;&#x2F;span&gt;&lt;span&gt;    world.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;move_v&lt;&#x2F;span&gt;&lt;span&gt;(player, speed.y &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;get_frame_time&lt;&#x2F;span&gt;&lt;span&gt;());
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; and to draw the player we ask the crate for the player&amp;#39;s current position:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; pos &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; world.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;actor_pos&lt;&#x2F;span&gt;&lt;span&gt;(player.collider);
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;gist.github.com&#x2F;not-fl3&#x2F;a51dbff5f09c04d5a371e55db4c48e13&quot;&gt;Full source code&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Now the fish can jump!&lt;&#x2F;p&gt;
&lt;img src=&quot;&#x2F;fishgame_tutorial&#x2F;fish_jump.gif&quot;  width=&quot;100%&quot;&#x2F;&gt;
&lt;h2 id=&quot;nodes&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#nodes&quot; aria-label=&quot;Anchor link for: nodes&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Nodes&lt;&#x2F;h2&gt;
&lt;p&gt;Now we have enough of a game to start adding Nakama networking. Just one final piece missing.&lt;&#x2F;p&gt;
&lt;p&gt;So far, the game code looks like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span&gt;async &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;main&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;   &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; load some resources
&lt;&#x2F;span&gt;&lt;span&gt;   &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; and initialize more variables
&lt;&#x2F;span&gt;&lt;span&gt;   &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;loop &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;       &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; check input and change some variables
&lt;&#x2F;span&gt;&lt;span&gt;       &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; make a few draw calls based on the variables content
&lt;&#x2F;span&gt;&lt;span&gt;       
&lt;&#x2F;span&gt;&lt;span&gt;       &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; and repeat this forever
&lt;&#x2F;span&gt;&lt;span&gt;       &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;next_frame&lt;&#x2F;span&gt;&lt;span&gt;().await;
&lt;&#x2F;span&gt;&lt;span&gt;   }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This may be good enough for a quick prototype. But for the whole Fish Game, we are going to have quite a few things in those variables:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;other players&lt;&#x2F;li&gt;
&lt;li&gt;weapons&lt;&#x2F;li&gt;
&lt;li&gt;bullets&lt;&#x2F;li&gt;
&lt;li&gt;level decorations&lt;&#x2F;li&gt;
&lt;li&gt;some UI&lt;&#x2F;li&gt;
&lt;li&gt;some visual effects&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;Macroquad does not force any specific way to store data or game objects. Macroquad does have some embedded ways for organizing scenes and is friendly for any third-party ECS-like crates.&lt;&#x2F;p&gt;
&lt;p&gt;For Fish Game, we are going to use macroquad&#x27;s scenes. &lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;struct &lt;&#x2F;span&gt;&lt;span&gt;Player {
&lt;&#x2F;span&gt;&lt;span&gt;    collider: Actor,
&lt;&#x2F;span&gt;&lt;span&gt;    speed: Vec2,
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;impl &lt;&#x2F;span&gt;&lt;span&gt;Player {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub const &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;JUMP_SPEED&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;f32 = -&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;700.0&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub const &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;GRAVITY&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;f32 = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;2000.0&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub const &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;MOVE_SPEED&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;f32 = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;300.0&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;() -&amp;gt; Player {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span&gt; resources &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;storage::get_mut::&amp;lt;Resources&amp;gt;().&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        Player {
&lt;&#x2F;span&gt;&lt;span&gt;            collider: resources.physics.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;add_actor&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;vec2&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;200.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;100.0&lt;&#x2F;span&gt;&lt;span&gt;), &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;36&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;66&lt;&#x2F;span&gt;&lt;span&gt;),
&lt;&#x2F;span&gt;&lt;span&gt;            speed: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;vec2&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.&lt;&#x2F;span&gt;&lt;span&gt;),
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;impl &lt;&#x2F;span&gt;&lt;span&gt;Node &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;for &lt;&#x2F;span&gt;&lt;span&gt;Player {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;draw&lt;&#x2F;span&gt;&lt;span&gt;(node: RefMut&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; resources &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;storage::get_mut::&amp;lt;Resources&amp;gt;().&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; pos &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; resources.physics.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;actor_pos&lt;&#x2F;span&gt;&lt;span&gt;(node.collider);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;draw_texture_ex&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;            resources.whale,
&lt;&#x2F;span&gt;&lt;span&gt;            pos.x &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;- &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;20.&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;            pos.y,
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;WHITE&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;            DrawTextureParams {
&lt;&#x2F;span&gt;&lt;span&gt;                source: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Some&lt;&#x2F;span&gt;&lt;span&gt;(Rect::new(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;76.&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;66.&lt;&#x2F;span&gt;&lt;span&gt;)),
&lt;&#x2F;span&gt;&lt;span&gt;                &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;..&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Default&lt;&#x2F;span&gt;&lt;span&gt;::default()
&lt;&#x2F;span&gt;&lt;span&gt;            },
&lt;&#x2F;span&gt;&lt;span&gt;        );
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;update&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;mut &lt;&#x2F;span&gt;&lt;span&gt;node: RefMut&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; world &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &amp;amp;mut &lt;&#x2F;span&gt;&lt;span&gt;storage::get_mut::&amp;lt;Resources&amp;gt;().&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;().physics;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; pos &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; world.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;actor_pos&lt;&#x2F;span&gt;&lt;span&gt;(node.collider);
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; on_ground &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; world.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;collide_check&lt;&#x2F;span&gt;&lt;span&gt;(node.collider, pos &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;+ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;vec2&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;1.&lt;&#x2F;span&gt;&lt;span&gt;));
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; on_ground &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;== &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;false &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;            node.speed.y &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;+= Self&lt;&#x2F;span&gt;&lt;span&gt;::&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;GRAVITY &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;get_frame_time&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;is_key_down&lt;&#x2F;span&gt;&lt;span&gt;(KeyCode::Right) {
&lt;&#x2F;span&gt;&lt;span&gt;            node.speed.x &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= Self&lt;&#x2F;span&gt;&lt;span&gt;::&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;MOVE_SPEED&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;        } &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;else if &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;is_key_down&lt;&#x2F;span&gt;&lt;span&gt;(KeyCode::Left) {
&lt;&#x2F;span&gt;&lt;span&gt;            node.speed.x &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= -Self&lt;&#x2F;span&gt;&lt;span&gt;::&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;MOVE_SPEED&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;        } &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;else &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;            node.speed.x &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0.&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;is_key_pressed&lt;&#x2F;span&gt;&lt;span&gt;(KeyCode::Space) {
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; on_ground {
&lt;&#x2F;span&gt;&lt;span&gt;                node.speed.y &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= Self&lt;&#x2F;span&gt;&lt;span&gt;::&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;JUMP_SPEED&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;            }
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        world.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;move_h&lt;&#x2F;span&gt;&lt;span&gt;(node.collider, node.speed.x &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;get_frame_time&lt;&#x2F;span&gt;&lt;span&gt;());
&lt;&#x2F;span&gt;&lt;span&gt;        world.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;move_v&lt;&#x2F;span&gt;&lt;span&gt;(node.collider, node.speed.y &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;* &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;get_frame_time&lt;&#x2F;span&gt;&lt;span&gt;());
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;async &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;main&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; this is it, now it will get its draw&#x2F;update calls 
&lt;&#x2F;span&gt;&lt;span&gt;    scene::add_node(Player::new());
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;gist.github.com&#x2F;not-fl3&#x2F;a98d9f9e37a01be8bc2f0d246164b8bb&quot;&gt;Full source code&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;It may not look like a big improvement over the previous approach, but scenes allow building complicated node relationships and applying iteration strategies over scene nodes. We are going to use it a lot more in the upcoming sections.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;networking-with-nakama&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#networking-with-nakama&quot; aria-label=&quot;Anchor link for: networking-with-nakama&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Networking with Nakama&lt;&#x2F;h1&gt;
&lt;p&gt;The &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;heroiclabs&#x2F;nakama-rs&#x2F;&quot;&gt;&amp;quot;nakama-rs&amp;quot;&lt;&#x2F;a&gt; crate is a pure Rust implementation of the Nakama protocol.&lt;&#x2F;p&gt;
&lt;p&gt;It allows working with Nakama in three different styles. &lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;nakama-rs can produce raw data with either HTTP or WebSocket requests, but leaves the networking implementation for the user.&lt;&#x2F;li&gt;
&lt;li&gt;nakama-rs can make Rest&#x2F;WebSocket calls with that raw data, but with a very low-level interface over requests.&lt;&#x2F;li&gt;
&lt;li&gt;Very high-level stateful client, which hides implementation details completely.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;For Fish Game, we are going to use that high-level client.  That client works as a giant state machine - the user makes non-blocking calls, and the client may change some internal state based on those calls.
Than in the main loop game pull changes from the ApiClient and may react accordingly.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;connecting-to-nakama&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#connecting-to-nakama&quot; aria-label=&quot;Anchor link for: connecting-to-nakama&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Connecting to Nakama&lt;&#x2F;h2&gt;
&lt;p&gt;nakama-rs&#x27; ApiClient will be used as a singleton. Once a global object is created, it is persisted throughout the game lifetime and is globally accessible.&lt;&#x2F;p&gt;
&lt;p&gt;In macroquad, we can use the node system for this. It will still be a singleton, but the access and relationship graph with our new Nakama node will be easily traceable and visible.&lt;&#x2F;p&gt;
&lt;p&gt;So we will create a scene node with ApiClient and  pass a reference to this node to all nodes communicating with Nakama.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub struct &lt;&#x2F;span&gt;&lt;span&gt;Nakama {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub &lt;&#x2F;span&gt;&lt;span&gt;api_client: ApiClient,
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;impl &lt;&#x2F;span&gt;&lt;span&gt;Nakama {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;new&lt;&#x2F;span&gt;&lt;span&gt;(key: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;str&lt;&#x2F;span&gt;&lt;span&gt;, server: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;str&lt;&#x2F;span&gt;&lt;span&gt;, port: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;u32&lt;&#x2F;span&gt;&lt;span&gt;, protocol: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;str&lt;&#x2F;span&gt;&lt;span&gt;) -&amp;gt; Nakama {
&lt;&#x2F;span&gt;&lt;span&gt;        Nakama {
&lt;&#x2F;span&gt;&lt;span&gt;            api_client: ApiClient::new(key, server, port, protocol),
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;impl &lt;&#x2F;span&gt;&lt;span&gt;scene::Node &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;for &lt;&#x2F;span&gt;&lt;span&gt;Nakama {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;ready&lt;&#x2F;span&gt;&lt;span&gt;(node: RefMut&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; Once created, nakama node should never be deleted.
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; The persist() call will make nakama node a singleton,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; alive during all scene reloads.
&lt;&#x2F;span&gt;&lt;span&gt;        node.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;persist&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;update&lt;&#x2F;span&gt;&lt;span&gt;(node: RefMut&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; api_client should be &amp;quot;ticked&amp;quot; once per frame
&lt;&#x2F;span&gt;&lt;span&gt;        self.api_client.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;tick&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;async &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;main&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; now the first node in the scene will be a nakama node
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; nakama &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;scene::add_node(nodes::Nakama::new(
&lt;&#x2F;span&gt;&lt;span&gt;        credentials::&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;NAKAMA_KEY&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        credentials::&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;NAKAMA_SERVER&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        credentials::&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;NAKAMA_PORT&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        credentials::&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;NAKAMA_PROTOCOL&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;    ));
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;...
&lt;&#x2F;span&gt;&lt;span&gt;} 
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;authentication-and-registration&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#authentication-and-registration&quot; aria-label=&quot;Anchor link for: authentication-and-registration&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Authentication and registration&lt;&#x2F;h2&gt;
&lt;p&gt;Macroquad uses the immediate mode gui concept for UI. Here we will skip GUI style setup (it may be found &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;heroiclabs&#x2F;fishgame-macroquad&#x2F;blob&#x2F;master&#x2F;src&#x2F;gui.rs#L36&quot;&gt;here&lt;&#x2F;a&gt;), and we will proceed to the UI logic instead.&lt;&#x2F;p&gt;
&lt;img src=&quot;&#x2F;fishgame_tutorial&#x2F;login.png&quot;  width=&quot;100%&quot;&#x2F;&gt;
&lt;p&gt;Most UI windows interacting with Nakama are built in the same way:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;get Nakama node&lt;&#x2F;li&gt;
&lt;li&gt;check if some operation is in progress, and if it is - show loading UI&lt;&#x2F;li&gt;
&lt;li&gt;check if there is some error to show&lt;&#x2F;li&gt;
&lt;li&gt;check if Nakama finished the required operation and can proceed to the next window&lt;&#x2F;li&gt;
&lt;li&gt;draw all input elements and on some button press - make a Nakama request&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span&gt; email &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;String&lt;&#x2F;span&gt;&lt;span&gt;::new();
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span&gt; password &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;String&lt;&#x2F;span&gt;&lt;span&gt;::new();
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;loop &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; nakama &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;scene::get_node(nakama).&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;            
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; nakama.api_client.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;in_progress&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;in_progress_gui&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;return&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if let &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Some&lt;&#x2F;span&gt;&lt;span&gt;(error) &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; nakama.api_client.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;error&lt;&#x2F;span&gt;&lt;span&gt;().&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;as_deref&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;        ui.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;label&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;None&lt;&#x2F;span&gt;&lt;span&gt;, error);
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; nakama.api_client.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;authenticated&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; done with authentication, proceeding to matchmaking
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;return &lt;&#x2F;span&gt;&lt;span&gt;Scene::MatchmakingLobby;
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    widgets::InputText::new(hash!())
&lt;&#x2F;span&gt;&lt;span&gt;        .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;label&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Email&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;        .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;ui&lt;&#x2F;span&gt;&lt;span&gt;(ui, &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;mut&lt;&#x2F;span&gt;&lt;span&gt; email);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    widgets::InputText::new(hash!())
&lt;&#x2F;span&gt;&lt;span&gt;        .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;password&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;true&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;        .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;label&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Password&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;        .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;ui&lt;&#x2F;span&gt;&lt;span&gt;(ui, &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;mut&lt;&#x2F;span&gt;&lt;span&gt; password);
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; ui.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;button&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;None&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Login&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;        nakama.api_client.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;authenticate&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;email, &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;password);
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;next_frame&lt;&#x2F;span&gt;&lt;span&gt;().await;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;real-time-multiplayer&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#real-time-multiplayer&quot; aria-label=&quot;Anchor link for: real-time-multiplayer&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Real-time multiplayer&lt;&#x2F;h2&gt;
&lt;p&gt;&lt;em&gt;The real-time multiplayer engine makes it easy for users to set up and join matches where they can rapidly exchange data with opponents.
Any user can participate in matches with other users. Users can create, join, and leave matches with messages sent from clients. A match exists on the server until its last participant has left.
Any data sent through a match is immediately routed to all other participants. The matches are kept in memory and can be persisted as needed.&lt;&#x2F;em&gt;
&lt;a href=&quot;https:&#x2F;&#x2F;heroiclabs.com&#x2F;docs&#x2F;gameplay-multiplayer-realtime&#x2F;&quot;&gt;source&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Match window code is very similar to the authentication window, as well as all other windows in Fish Game:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;loop &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; check if nakama is in progress 
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; check if nakama has errors
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; check if nakama finished and we can return
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; draw some input widgets and maybe make nakama request
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now let&#x27;s focus on how Nakama&#x27;s real-time matches work.&lt;&#x2F;p&gt;
&lt;img src=&quot;&#x2F;fishgame_tutorial&#x2F;matchmaker.png&quot;  width=&quot;100%&quot;&#x2F;&gt;
&lt;p&gt;To create a match:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span&gt;nakama.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;socket_create_match&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This will start a process that on success will give some id in &lt;code&gt;nakama.match_id()&lt;&#x2F;code&gt;. &lt;&#x2F;p&gt;
&lt;p&gt;This ID may be shared to friends to join this exact match later: &lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span&gt;nakama.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;socket_join_match_by_id&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;match_id);
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We have two problems here: &lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Match discoverability.
Sharing a match id with a friend works for private games, but we need a better solution for public games.
This will be addressed in the &lt;a href=&quot;https:&#x2F;&#x2F;macroquad.rs&#x2F;articles&#x2F;fish-tutorial&#x2F;#Matchmaker&quot;&gt;Matchmaker&lt;&#x2F;a&gt; section.&lt;&#x2F;li&gt;
&lt;li&gt;Nakama considers a match started right after the &lt;code&gt;create_match&lt;&#x2F;code&gt; call, and anyone can join at any moment. While the rules of Fish Game won&#x27;t let players join in the middle, and the game starts only when all of the players have pressed the â€œreadyâ€ button.
This will be addressed in the &lt;a href=&quot;https:&#x2F;&#x2F;macroquad.rs&#x2F;articles&#x2F;fish-tutorial&#x2F;#Ready-window&quot;&gt;Ready window&lt;&#x2F;a&gt; section.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;h2 id=&quot;matchmaker&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#matchmaker&quot; aria-label=&quot;Anchor link for: matchmaker&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Matchmaker&lt;&#x2F;h2&gt;
&lt;p&gt;You can use the Matchmaker to find other players. It is possible to match them using properties and a query that specifies the values the other players&#x27; properties should hold. In &lt;code&gt;nakama-rs&lt;&#x2F;code&gt; the Matchmaker is a &lt;code&gt;struct&lt;&#x2F;code&gt; and can be created using &lt;code&gt;Matchmaker::new()&lt;&#x2F;code&gt;. There are two types of properties, string properties and numeric properties that can be added with &lt;code&gt;matchmaker.add_string_property(&amp;quot;name&amp;quot;, &amp;quot;value&amp;quot;)&lt;&#x2F;code&gt; and &lt;code&gt;matchmaker.add_numeric_property(&amp;quot;rank&amp;quot;, 1000.0)&lt;&#x2F;code&gt; respectively. Names of properties should be unique across both types.&lt;&#x2F;p&gt;
&lt;p&gt;The query is a space-separated string using the &lt;a href=&quot;http:&#x2F;&#x2F;blevesearch.com&#x2F;docs&#x2F;Query-String-Query&#x2F;&quot;&gt;Bleve Query-String-Query Syntax&lt;&#x2F;a&gt;. It is possible to add queries manually using &lt;code&gt;matchmaker.add_query_item(&amp;quot;properties.region:Europe&amp;quot;)&lt;&#x2F;code&gt; but &lt;code&gt;nakama-rs&lt;&#x2F;code&gt; provides a helper to construct the query string using the builder pattern. For now, terms, numeric ranges, required, optional and exclusion are supported. See &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;heroiclabs&#x2F;nakama-rs&#x2F;blob&#x2F;master&#x2F;examples&#x2F;matchmaker.rs&quot;&gt;examples&#x2F;matchmaker.rs&lt;&#x2F;a&gt; for more examples.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; By default query items are optional. The Matchmaker will prefer
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; players holding the value, but will also match players without it.
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; Prefer players from Europe.
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; query_item &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;QueryItemBuilder::new(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;region&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;term&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Europe&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;build&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; Only match with players from Europe    
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; query_item &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;QueryItemBuilder::new(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;region&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;term&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Europe&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;required&lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;build&lt;&#x2F;span&gt;&lt;span&gt;();   
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; Only match with players not from Europe
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; query_item &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;QueryItemBuilder::new(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;region&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;term&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Europe&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;excluded&lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;build&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; query_item &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;QueryItemBuilder::new(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;rank&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;lt&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;10&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; or .gt(10), .leq(10) and .geq(10)
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;build&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In addition, it is possible to specify the minimum and the maximum number of players using &lt;code&gt;matchmaker.min(2)&lt;&#x2F;code&gt; and &lt;code&gt;matchmaker.max(100)&lt;&#x2F;code&gt;. The default values are 2 and 100, respectively.&lt;&#x2F;p&gt;
&lt;img src=&quot;&#x2F;fishgame_tutorial&#x2F;matchmaker2.png&quot;  width=&quot;100%&quot;&#x2F;&gt;
&lt;p&gt;Fish Game only specifies one property called &lt;code&gt;&amp;quot;engine&amp;quot;&lt;&#x2F;code&gt; with the value &lt;code&gt;macroquad_engine&lt;&#x2F;code&gt;. The query only specifies that we also match players holding the same value for that property, allowing us to avoid matchmaking players running a different game on the same Nakama server.&lt;&#x2F;p&gt;
&lt;p&gt;The full matchmaker setup can be seen below:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span&gt;widgets::InputText::new(hash!())
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;ratio&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;1. &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&#x2F; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;4.&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;filter_numbers&lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;label&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Minimum players&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;ui&lt;&#x2F;span&gt;&lt;span&gt;(ui, &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;mut&lt;&#x2F;span&gt;&lt;span&gt; minimum_players);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;widgets::InputText::new(hash!())
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;ratio&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;1. &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&#x2F; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;4.&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;filter_numbers&lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;label&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Maximum players&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;ui&lt;&#x2F;span&gt;&lt;span&gt;(ui, &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;mut&lt;&#x2F;span&gt;&lt;span&gt; maximum_players);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; ui.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;button&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;None&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Start matchmaking&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span&gt; matchmaker &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;Matchmaker::new();
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    matchmaker
&lt;&#x2F;span&gt;&lt;span&gt;        .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;min&lt;&#x2F;span&gt;&lt;span&gt;(minimum_players.parse::&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;u32&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;().&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;())
&lt;&#x2F;span&gt;&lt;span&gt;        .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;max&lt;&#x2F;span&gt;&lt;span&gt;(maximum_players.parse::&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;u32&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;().&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;())
&lt;&#x2F;span&gt;&lt;span&gt;        .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;add_string_property&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;engine&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;macroquad_matchmaking&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;        .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;add_query_item&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;QueryItemBuilder::new(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;engine&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;                .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;required&lt;&#x2F;span&gt;&lt;span&gt;()
&lt;&#x2F;span&gt;&lt;span&gt;                .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;term&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;macroquad_matchmaking&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;                .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;build&lt;&#x2F;span&gt;&lt;span&gt;(),
&lt;&#x2F;span&gt;&lt;span&gt;        );
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    nakama.api_client.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;socket_add_matchmaker&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;matchmaker);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    next_scene &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Some&lt;&#x2F;span&gt;&lt;span&gt;(Scene::WaitingForMatchmaking { private: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;false &lt;&#x2F;span&gt;&lt;span&gt;});
&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;You can add the Matchmaker by calling &lt;code&gt;nakama.socket_add_matchmaker(&amp;amp;matchmaker)&lt;&#x2F;code&gt;, adding the user to the server&#x27;s matchmaking pool. The user will stay in the pool until matched as long as they are online or until you remove them manually. It is possible to add multiple matchmakers with different queries simultaneously to look for different types of matches.&lt;&#x2F;p&gt;
&lt;p&gt;When the server matches the user, the ApiClient will handle the event and set &lt;code&gt;nakama.matchmaker_token&lt;&#x2F;code&gt; to &lt;code&gt;Some(token)&lt;&#x2F;code&gt;. The token is a short-lived entry ticket that you can use to join a match with the other matched players by calling &lt;code&gt;nakama.socket_join_match_by_token(token)&lt;&#x2F;code&gt;. The server creates the match as soon as the first player tries to join it and sends an event once the player joined successfully. In the client, &lt;code&gt;nakama.match_id()&lt;&#x2F;code&gt; will then contain a value. It is now possible to send match data between players.&lt;&#x2F;p&gt;
&lt;p&gt;For additional details, check out the &lt;a href=&quot;https:&#x2F;&#x2F;heroiclabs.com&#x2F;docs&#x2F;gameplay-matchmaker&quot;&gt;Matchmaker documentation&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;exchanging-messages&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#exchanging-messages&quot; aria-label=&quot;Anchor link for: exchanging-messages&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Exchanging messages&lt;&#x2F;h2&gt;
&lt;p&gt;nakama-rs&#x27;&lt;code&gt;ApiClient&lt;&#x2F;code&gt; provides two API calls to communicate between each other: &lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;fn socket_send&amp;lt;T: SerBin&amp;gt;(&amp;amp;self, opcode: u32, data: T)&lt;&#x2F;code&gt;
&lt;code&gt;socket_send&lt;&#x2F;code&gt; will binary serialize given message and broadcast it to each player in the room. Opcode here acts as a tag or discriminant in rust &lt;a href=&quot;https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;book&#x2F;ch06-01-defining-an-enum.html&quot;&gt;enum&lt;&#x2F;a&gt; - a small descriptor specifiyng what kind of data is being sent.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;code&gt;fn try_recv(&amp;amp;self) -&amp;gt; Option&amp;lt;Event&amp;gt;&lt;&#x2F;code&gt;
&lt;code&gt;try_recv&lt;&#x2F;code&gt; will give an Event if someone sent a message or joined&#x2F;left match since last &lt;code&gt;try_recv&lt;&#x2F;code&gt; call.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;A convenient Rust representation of an &lt;code&gt;opcode&lt;&#x2F;code&gt;&#x2F;&lt;code&gt;data&lt;&#x2F;code&gt; pair may look like this:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;mod &lt;&#x2F;span&gt;&lt;span&gt;message {
&lt;&#x2F;span&gt;&lt;span&gt;    #[derive(Debug, Clone, SerBin, DeBin, PartialEq)]
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub struct &lt;&#x2F;span&gt;&lt;span&gt;State {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub &lt;&#x2F;span&gt;&lt;span&gt;pos: (&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;u16&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;u16&lt;&#x2F;span&gt;&lt;span&gt;),
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub &lt;&#x2F;span&gt;&lt;span&gt;facing: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;bool&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;impl &lt;&#x2F;span&gt;&lt;span&gt;State {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub const &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;OPCODE&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;i32 = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    #[derive(Debug, Clone, SerBin, DeBin, PartialEq)]
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub struct &lt;&#x2F;span&gt;&lt;span&gt;Damage {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub &lt;&#x2F;span&gt;&lt;span&gt;target: String,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub &lt;&#x2F;span&gt;&lt;span&gt;direction: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;bool&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;impl &lt;&#x2F;span&gt;&lt;span&gt;Damage {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub const &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;OPCODE&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;i32 = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Then, in order to send some message:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span&gt;nakama.api_client.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;send&lt;&#x2F;span&gt;&lt;span&gt;(Damage::&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;OPCODE&lt;&#x2F;span&gt;&lt;span&gt;, Damage {
&lt;&#x2F;span&gt;&lt;span&gt;    target: target.network_id,
&lt;&#x2F;span&gt;&lt;span&gt;    direction: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;false
&lt;&#x2F;span&gt;&lt;span&gt;});
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;To recieve such a message on other client: &lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;while let &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Some&lt;&#x2F;span&gt;&lt;span&gt;(event) &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; nakama.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;try_recv&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;..
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Event may be either a message from other client or a system even like joined&#x2F;leaved player. This will be explained in details in &lt;a href=&quot;https:&#x2F;&#x2F;macroquad.rs&#x2F;articles&#x2F;fish-tutorial&#x2F;#Player-state-synchronization&quot;&gt;Player state syncronization&lt;&#x2F;a&gt; section.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;player-state-synchronization&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#player-state-synchronization&quot; aria-label=&quot;Anchor link for: player-state-synchronization&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Player state synchronization&lt;&#x2F;h2&gt;
&lt;p&gt;Fish Game uses a relayed network synchronization model. Each player simulates its physics and sends its state to other players.&lt;&#x2F;p&gt;
&lt;p&gt;One of the players is called &amp;quot;host&amp;quot; and is responsible for global events and conflict resolution.&lt;&#x2F;p&gt;
&lt;p&gt;Nakama node from previous chapters:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;impl &lt;&#x2F;span&gt;&lt;span&gt;scene::Node &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;for &lt;&#x2F;span&gt;&lt;span&gt;Nakama {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;update&lt;&#x2F;span&gt;&lt;span&gt;(node: RefMut&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;        node.api_client.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;tick&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now it will also take responsibility for state synchronization. &lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;impl &lt;&#x2F;span&gt;&lt;span&gt;scene::Node &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;for &lt;&#x2F;span&gt;&lt;span&gt;Nakama {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;update&lt;&#x2F;span&gt;&lt;span&gt;(node: RefMut&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; send our own player state to all the other players
&lt;&#x2F;span&gt;&lt;span&gt;        {
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; player &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;scene::find_node_by_type::&amp;lt;Player&amp;gt;().&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span&gt; state &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;message::State {
&lt;&#x2F;span&gt;&lt;span&gt;                pos: (player.pos.x &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as u16&lt;&#x2F;span&gt;&lt;span&gt;, player.pos.y &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as u16&lt;&#x2F;span&gt;&lt;span&gt;), 
&lt;&#x2F;span&gt;&lt;span&gt;                facing: player.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;facing&lt;&#x2F;span&gt;&lt;span&gt;(),
&lt;&#x2F;span&gt;&lt;span&gt;                &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;..
&lt;&#x2F;span&gt;&lt;span&gt;            };
&lt;&#x2F;span&gt;&lt;span&gt;            node.api_client.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;socket_send&lt;&#x2F;span&gt;&lt;span&gt;(message::State::&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;OPCODE&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;message::State(state.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;));
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;        node.api_client.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;tick&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;In the final game code, the &lt;code&gt;State&lt;&#x2F;code&gt; structure is slightly more &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;heroiclabs&#x2F;fishgame-macroquad&#x2F;blob&#x2F;master&#x2F;src&#x2F;nodes&#x2F;nakama&#x2F;nakama_realtime_game.rs#L67&quot;&gt;optimized&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Also, in the real game, network fps are different from the rendering fps - with networking lag sending state 60 times per second is too much, and ~15-20 should be enough. Fish Game works on 15.
But the idea is the same - The &lt;code&gt;Nakama&lt;&#x2F;code&gt; node packs all the important parts of the player state and sends it over the network to all the other players in the room. &lt;&#x2F;p&gt;
&lt;p&gt;Next step - receive other players&#x27; data and draw other players.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;struct &lt;&#x2F;span&gt;&lt;span&gt;Nakama {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; now Nakama node is keeping track on all remote players in the scene
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; key here is session_id from nakama presence - the always unique player identifier
&lt;&#x2F;span&gt;&lt;span&gt;    remote_players: HashMap&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;String&lt;&#x2F;span&gt;&lt;span&gt;, Handle&amp;lt;RemotePlayer&amp;gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;impl &lt;&#x2F;span&gt;&lt;span&gt;scene::Node &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;for &lt;&#x2F;span&gt;&lt;span&gt;Nakama {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;update&lt;&#x2F;span&gt;&lt;span&gt;(node: RefMut&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; send our own player state to all the other players
&lt;&#x2F;span&gt;&lt;span&gt;        {
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;..
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;        
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; receive other players updates
&lt;&#x2F;span&gt;&lt;span&gt;        {
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;while let &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Some&lt;&#x2F;span&gt;&lt;span&gt;(event) &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; nakama.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;try_recv&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;                &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; proceed event and modify the scene somehow
&lt;&#x2F;span&gt;&lt;span&gt;                &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;..
&lt;&#x2F;span&gt;&lt;span&gt;            }
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;        node.api_client.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;tick&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;That is the bare-bones implementation - for each frame, we receive all the Nakama events and apply changes to the scene. 
We need to have a list of &lt;code&gt;remote_players&lt;&#x2F;code&gt; to track the scene nodes of remote players and add&#x2F;remove players on game joins or leaves. And we need to apply the received messages to those remote players.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;match&lt;&#x2F;span&gt;&lt;span&gt; event {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; add or remove RemotePlayer node
&lt;&#x2F;span&gt;&lt;span&gt;    Event::::Presence { joins, leaves } &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&amp;gt; &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;for&lt;&#x2F;span&gt;&lt;span&gt; joined &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;in&lt;&#x2F;span&gt;&lt;span&gt; joins {
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; joined_id &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; join.session_id;
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; username &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; join.username;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; remote_player &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;RemotePlayer::new(&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;username, &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;joined);
&lt;&#x2F;span&gt;&lt;span&gt;             self.remote_players.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;insert&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span&gt;                joined.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;clone&lt;&#x2F;span&gt;&lt;span&gt;(),
&lt;&#x2F;span&gt;&lt;span&gt;                scene::add_node(remote_player),
&lt;&#x2F;span&gt;&lt;span&gt;            );
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;for&lt;&#x2F;span&gt;&lt;span&gt; leaver &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;in&lt;&#x2F;span&gt;&lt;span&gt; leaves {
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; other &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;self.remote_players.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;remove&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;leaver).&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; leaver &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;scene::get_node::&amp;lt;RemotePlayer&amp;gt;(leaver).&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;            other.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;delete&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This will keep the list of active remote players accurate, and for each, we will have a RemotePlayer node.&lt;&#x2F;p&gt;
&lt;p&gt;The RemotePlayer node may be very similar to the Player node but with very different logic.&lt;&#x2F;p&gt;
&lt;p&gt;Then continue the event handling &lt;code&gt;match&lt;&#x2F;code&gt; to deal with a data message:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; received opcode&#x2F;data pair
&lt;&#x2F;span&gt;&lt;span&gt;Event::MatchData {
&lt;&#x2F;span&gt;&lt;span&gt;    user_id,
&lt;&#x2F;span&gt;&lt;span&gt;    opcode,
&lt;&#x2F;span&gt;&lt;span&gt;    data,
&lt;&#x2F;span&gt;&lt;span&gt;} &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&amp;gt; &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if let &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Some&lt;&#x2F;span&gt;&lt;span&gt;(remote_player) &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;self.remote_players.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;get&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;user_id) {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let mut&lt;&#x2F;span&gt;&lt;span&gt; remote_player &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;scene::get_node(&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;remote_player).&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;match&lt;&#x2F;span&gt;&lt;span&gt; opcode &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as i32 &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;            message::State::&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;OPCODE &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&amp;gt; &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;                &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; deserialize message according to opcode
&lt;&#x2F;span&gt;&lt;span&gt;                &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let &lt;&#x2F;span&gt;&lt;span&gt;message::State(data) &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;DeBin::deserialize_bin(&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;data).&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;                &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; and apply message data to the remote player node
&lt;&#x2F;span&gt;&lt;span&gt;                remote_player.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;set_pos&lt;&#x2F;span&gt;&lt;span&gt;(data.pos.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0 &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as f32&lt;&#x2F;span&gt;&lt;span&gt;, data.pos.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;1 &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as f32&lt;&#x2F;span&gt;&lt;span&gt;);
&lt;&#x2F;span&gt;&lt;span&gt;                remote_player.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;set_facing&lt;&#x2F;span&gt;&lt;span&gt;(data.facing);
&lt;&#x2F;span&gt;&lt;span&gt;            }
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;} 
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;heroiclabs&#x2F;fishgame-macroquad&#x2F;blob&#x2F;master&#x2F;src&#x2F;nodes&#x2F;nakama&#x2F;nakama_realtime_game.rs&quot;&gt;&lt;em&gt;src&#x2F;nodes&#x2F;nakama&#x2F;nakama_realtime_game.rs&lt;&#x2F;em&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;a-note-about-network-performance&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#a-note-about-network-performance&quot; aria-label=&quot;Anchor link for: a-note-about-network-performance&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;A note about network performance&lt;&#x2F;h2&gt;
&lt;p&gt;While Fish Game has good enough network performance to be fully functional, it is kept intentionally simplistic for demonstration purposes.&lt;&#x2F;p&gt;
&lt;p&gt;Nakamaâ€™s real-time Multiplayer API sends data over WebSockets, which means TCP. TCP is reliable (you know if the message you sent arrived or not), but itâ€™s slower. For an in-depth explanation about the trade-offs between TCP and UDP, see &lt;a href=&quot;https:&#x2F;&#x2F;heroiclabs.com&#x2F;docs&#x2F;expert-tcp-udp&#x2F;&quot;&gt;Choosing TCP or UDP: a guide for game developers&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;Fast-paced games commonly use UDP to send synchronization information: itâ€™s unreliable (your message can get lost) but faster. Using unreliable UDP would allow for some network optimizations that we canâ€™t do here. For example, with some kinds of game states, only the most recent message is valid (all older messages are immediately invalid once a newer one arrives), so we could use the faster UDP packets.
Itâ€™s OK if some get lost, we&#x27;d just take the newest one that arrives.&lt;&#x2F;p&gt;
&lt;p&gt;This game is fast-paced enough that it ideally should be using â€œinput prediction and rollbackâ€ rather than â€œinput prediction and correctionâ€. When using rollback, rather than applying the corrections you received to the current state of the game, you roll back the local game state to the time when the remote state was generated, apply it, and then roll the game state forward to the current time. This can help eliminate lag and avoid situations where one player sees themselves hitting another player, but it doesnâ€™t  register as a hit. However, rollback is a lot more complicated to implement than correction. Fish Game has enough in common with arcade-style Fighting Games that the most optimal networking technique for it might be the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;pond3r&#x2F;ggpo&quot;&gt;GGPO&lt;&#x2F;a&gt; technique.&lt;&#x2F;p&gt;
&lt;p&gt;This would merit further investigation if this was a commercial game.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;global-events-and-conflicts-resolution&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#global-events-and-conflicts-resolution&quot; aria-label=&quot;Anchor link for: global-events-and-conflicts-resolution&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Global events and conflicts resolution&lt;&#x2F;h2&gt;
&lt;p&gt;In Fish Game, we have some global events. Good example: Spawn process of pickable weapon.&lt;&#x2F;p&gt;
&lt;p&gt;There are two ways to simulate such a process:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;Make it deterministic and simulate it on each client.&lt;&#x2F;li&gt;
&lt;li&gt;Call one of the clients â€œhostâ€. Simulate such an event only on that client and this client will tell everyone else which weapon spawned where.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;With the deterministic approach, we are going to have a problem with conflicts - if two players correctly simulated that they picked the weapon at the very same time, who is right? &lt;&#x2F;p&gt;
&lt;p&gt;With the &amp;quot;host&amp;quot; approach it is way easier - the host may be responsible for such decisions.&lt;&#x2F;p&gt;
&lt;p&gt;While all the players have unique IDs and everyone knows each other&#x27;s ID, we can just sort the list of &lt;code&gt;remote_players&lt;&#x2F;code&gt; IDs and whoever&#x27;s first is the host. &lt;&#x2F;p&gt;
&lt;p&gt;Now we can create a special node, &lt;code&gt;GlobalEvents&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub struct &lt;&#x2F;span&gt;&lt;span&gt;GlobalEvents {
&lt;&#x2F;span&gt;&lt;span&gt;    nakama: NodeHandle&amp;lt;Nakama&amp;gt;,
&lt;&#x2F;span&gt;&lt;span&gt;    last_spawn_time: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;f32&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;impl &lt;&#x2F;span&gt;&lt;span&gt;scene::Node &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;for &lt;&#x2F;span&gt;&lt;span&gt;GlobalEvents {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;update&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;mut &lt;&#x2F;span&gt;&lt;span&gt;node: RefMut&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;Self&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;) {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; nakama &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span&gt;scene::get_node(node.nakama).&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;        
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; nakama.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;is_host&lt;&#x2F;span&gt;&lt;span&gt;() &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;== &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;false &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;return&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;get_time&lt;&#x2F;span&gt;&lt;span&gt;() &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;-&lt;&#x2F;span&gt;&lt;span&gt; node.last_spawn_time &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;gt;= Self&lt;&#x2F;span&gt;&lt;span&gt;::&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;SPAWN_INTERVAL &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;as _
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt; node.spawned_items.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;len&lt;&#x2F;span&gt;&lt;span&gt;() &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;lt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;3 &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; new_item_pos &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= ..&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;let&lt;&#x2F;span&gt;&lt;span&gt; new_item_type &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= ..&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;            
&lt;&#x2F;span&gt;&lt;span&gt;            nakama.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;spawn_item&lt;&#x2F;span&gt;&lt;span&gt;(new_item_pos, new_item_type);    
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;        
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;heroiclabs&#x2F;fishgame-macroquad&#x2F;blob&#x2F;master&#x2F;src&#x2F;nodes&#x2F;global_events.rs&quot;&gt;&lt;em&gt;src&#x2F;nodes&#x2F;global_events.rs&lt;&#x2F;em&gt;&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;h2 id=&quot;ready-window&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#ready-window&quot; aria-label=&quot;Anchor link for: ready-window&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Ready window&lt;&#x2F;h2&gt;
&lt;img src=&quot;&#x2F;fishgame_tutorial&#x2F;ready.png&quot;  width=&quot;100%&quot;&#x2F;&gt;
&lt;p&gt;One of our unsolved problems: in Fish Game the game starts only when all the players joined the match, can see each other and has opted in as ready. &lt;&#x2F;p&gt;
&lt;p&gt;After this point, it is impossible to join a match and only one last standing fish will win.&lt;&#x2F;p&gt;
&lt;p&gt;All this logic may be implemented on top of Nakama&#x27;s messages.&lt;&#x2F;p&gt;
&lt;p&gt;We can add a flag to our Nakama node:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;struct &lt;&#x2F;span&gt;&lt;span&gt;Nakama {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub &lt;&#x2F;span&gt;&lt;span&gt;api_client: ApiClient,
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub &lt;&#x2F;span&gt;&lt;span&gt;game_started: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;bool 
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And introduce a special message:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;mod &lt;&#x2F;span&gt;&lt;span&gt;messages {
&lt;&#x2F;span&gt;&lt;span&gt;    #[derive(Debug, Clone, SerBin, DeBin, PartialEq)]
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub struct &lt;&#x2F;span&gt;&lt;span&gt;Ready;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;impl &lt;&#x2F;span&gt;&lt;span&gt;Ready {
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;pub const &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;OPCODE&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;i32 = &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;6&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;Now it is the game&#x27;s responsibility to figure when to start a match. In Fish Game rules are quite simple - before everyone pushed &amp;quot;Ready&amp;quot; and the host confirmed by pushing &amp;quot;Start game&amp;quot; - no loot is spawning and noone is allowed to move. Implementation is in &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;heroiclabs&#x2F;fishgame-macroquad&#x2F;blob&#x2F;master&#x2F;src&#x2F;nodes&#x2F;nakama&#x2F;nakama_realtime_game.rs&quot;&gt;nakama node&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;p&gt;But this logic may be totally different depending on game design, and the goal of this little chapter - demonstrate where nakama&#x27;s area of responsibility in the matchmaker&#x2F;match logic ends and game should roll its own logic. &lt;&#x2F;p&gt;
&lt;h2 id=&quot;leaderboards&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#leaderboards&quot; aria-label=&quot;Anchor link for: leaderboards&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Leaderboards&lt;&#x2F;h2&gt;
&lt;p&gt;Thereâ€™s one last Nakama feature weâ€™re going to look at before ending this tutorial: Leaderboards.&lt;&#x2F;p&gt;
&lt;p&gt;Leaderboards need to be created on the server before your game can write data to them. This is done in Fish Game by adding a small server-side Lua module in &lt;code&gt;nakama&#x2F;data&#x2F;modules&#x2F;fish_game.lua&lt;&#x2F;code&gt;:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;lua&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-lua &quot;&gt;&lt;code class=&quot;language-lua&quot; data-lang=&quot;lua&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;local &lt;&#x2F;span&gt;&lt;span&gt;nk &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;require&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;nakama&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;nk.run_once(&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;function&lt;&#x2F;span&gt;&lt;span&gt;(context)
&lt;&#x2F;span&gt;&lt;span&gt;  nk.leaderboard_create(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;fish_game_wins&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;false&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;desc&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;incr&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;end&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;This runs on the Nakama server at startup and creates a leaderboard called â€œfishgamewinsâ€, which weâ€™re going to use to track the total number of wins that each player has gotten.&lt;&#x2F;p&gt;
&lt;p&gt;Itâ€™s a non-authoritative leaderboard (the &lt;code&gt;false&lt;&#x2F;code&gt; in the 2nd argument), which means that the game clients can modify the leaderboard themselves, rather than requiring server-side logic to do it. Itâ€™s sorted in descending order (the &amp;quot;desc&amp;quot; in the 3rd argument) and is updated by incrementing the score (the &amp;quot;incr&amp;quot; in the 4th argument).&lt;&#x2F;p&gt;
&lt;p&gt;Note: Nakama modules can be written in Lua, Go or (in Nakama 3) JavaScript.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;posting-results-to-the-leaderboard&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#posting-results-to-the-leaderboard&quot; aria-label=&quot;Anchor link for: posting-results-to-the-leaderboard&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Posting results to the leaderboard&lt;&#x2F;h2&gt;
&lt;img src=&quot;&#x2F;fishgame_tutorial&#x2F;back_to_lobby.png&quot;  width=&quot;100%&quot;&#x2F;&gt;
&lt;p&gt;When only one fish is alive and the game has ended, the winner may update the leaderboard record.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span&gt;nakama.api_client.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;write_leaderboard_record&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;fish_game_wins&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;We may want to wait for the result status to display some error and retry if we got a network error.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;accessing-the-leaderboard&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#accessing-the-leaderboard&quot; aria-label=&quot;Anchor link for: accessing-the-leaderboard&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Accessing the leaderboard&lt;&#x2F;h2&gt;
&lt;img src=&quot;&#x2F;fishgame_tutorial&#x2F;leaderboard.png&quot;  width=&quot;100%&quot;&#x2F;&gt;
&lt;p&gt;The leaderboard window is not much different from the authentication&#x2F;matchmaking window.&lt;&#x2F;p&gt;
&lt;p&gt;First, make the Nakama request: &lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span&gt;nakama.api_client.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;list_leaderboard_records&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;fish_game_wins&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And then on success we will have something in &lt;code&gt;api_client.leaderboard_records&lt;&#x2F;code&gt;&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;if let &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Some&lt;&#x2F;span&gt;&lt;span&gt;(leaderboard) &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; nakama
&lt;&#x2F;span&gt;&lt;span&gt;    .api_client
&lt;&#x2F;span&gt;&lt;span&gt;    .&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;leaderboard_records&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;fish_game_wins&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;for&lt;&#x2F;span&gt;&lt;span&gt; record &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;in &amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;leaderboard.records {
&lt;&#x2F;span&gt;&lt;span&gt;        ui.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;label&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;None&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt;format!(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;{}&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;{}&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, record.username, record.score));
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
</content>
	</entry>
	<entry xml:lang="en">
		<title>JavaScript interop with miniquad</title>
		<published>2021-04-01T20:10:42+00:00</published>
		<updated>2021-04-01T20:10:42+00:00</updated>
		<link rel="alternate" href="https://macroquad.rs/articles/wasm/" type="text/html"/>
		<id>https://macroquad.rs/articles/wasm/</id>
		<content type="html">&lt;h1 id=&quot;intro&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#intro&quot; aria-label=&quot;Anchor link for: intro&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Intro&lt;&#x2F;h1&gt;
&lt;p&gt;A short intro into the current state of wasm:&lt;&#x2F;p&gt;
&lt;p&gt;&lt;code&gt;cargo build --target wasm32-unknown-unknown&lt;&#x2F;code&gt; will produce &lt;code&gt;.wasm&lt;&#x2F;code&gt; file. &lt;&#x2F;p&gt;
&lt;p&gt;One .wasm file is one &amp;quot;module&amp;quot;. The module is very similar to &lt;code&gt;.o&lt;&#x2F;code&gt; or &lt;code&gt;.dll&lt;&#x2F;code&gt; files on native platforms - its a dynamically loadable library with some functions.&lt;&#x2F;p&gt;
&lt;p&gt;What actually is inside wasm file: &lt;a href=&quot;https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;WebAssembly&#x2F;Understanding_the_text_format&quot;&gt;https:&#x2F;&#x2F;developer.mozilla.org&#x2F;en-US&#x2F;docs&#x2F;WebAssembly&#x2F;Understanding_the_text_format&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Each wasm module has two lists: import functions and export functions.&lt;br &#x2F;&gt;
Export functions: functions exported from wasm that can be called later from JS.&lt;br &#x2F;&gt;
Import functions: JS functions that can be called from any WASM function.&lt;&#x2F;p&gt;
&lt;p&gt;&amp;quot;wasm&amp;quot; can&#x27;t be included in the web page with &lt;code&gt;&amp;lt;script&amp;gt;&lt;&#x2F;code&gt; tag. Instead, &amp;quot;wasm&amp;quot; is loaded with a special JS code. &lt;&#x2F;p&gt;
&lt;p&gt;That loader code is doing this:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;load wasm binary data - download the file from the internet and get bytes&lt;&#x2F;li&gt;
&lt;li&gt;fill import functions table. all the JS functions that wasm use should be in that table&lt;&#x2F;li&gt;
&lt;li&gt;call browser api to instantiate wasm with the given import table&lt;&#x2F;li&gt;
&lt;li&gt;get references into nwo loaded wasm&#x27;s functions and wasm&#x27;s memory. Now JS can call our wasm! &lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;In miniquad&#x27;s case that JS loader code will also call &amp;quot;main&amp;quot; function from wasm export and will forward JS events as WASM functions calls.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;basic-usage&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#basic-usage&quot; aria-label=&quot;Anchor link for: basic-usage&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Basic usage&lt;&#x2F;h1&gt;
&lt;p&gt;To get wasm module with all necessary export functions: add &amp;quot;miniquad&amp;quot; as a dependency in Cargo.toml.
Then, to load this wasm module, use miniquad&#x27;s JS wasm loader. Right now its named as &amp;quot;gl.js&amp;quot; for historical reasons:&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;&amp;lt;script src=&amp;quot;https:&#x2F;&#x2F;not-fl3.github.io&#x2F;miniquad-samples&#x2F;gl.js&amp;quot;&amp;gt;&amp;lt;&#x2F;script&amp;gt; &amp;lt;!-- gl.js from miniquad repo (native&#x2F;sapp-wasm&#x2F;js&#x2F;gl.js) --&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;script&amp;gt;load(&amp;quot;quad.wasm&amp;quot;);&amp;lt;&#x2F;script&amp;gt; &amp;lt;!-- Your compiled wasm file --&amp;gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;advances-linking&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#advances-linking&quot; aria-label=&quot;Anchor link for: advances-linking&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Advances linking&lt;&#x2F;h1&gt;
&lt;p&gt;Sometimes miniquad&#x27;s API is not enough and custom javascript is needed.&lt;&#x2F;p&gt;
&lt;p&gt;miniquad&#x27;s gl.js will provide two global variables: &amp;quot;wasm_exports&amp;quot; and &amp;quot;wasm_memory&amp;quot;.&lt;&#x2F;p&gt;
&lt;p&gt;All rust&#x27;s &amp;quot;#[no_mangle] pub extern &amp;quot;C&amp;quot; fn function_name() {}&amp;quot; functions will be available to call from &amp;quot;wasm_exports&amp;quot;.&lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;wasm_exports.my_rust_function(1, 2, 3); &#x2F;&#x2F; make a wasm call from JS
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;To call js from rust, however, some initialization work need to be done. All JS functions available to wasm should be explicitly listed before wasm loading. Before &amp;quot;load&amp;quot; call in our case. 
The set of JS functions available to call from rust is called Plugin in miniquad&#x27;s terminology.&lt;&#x2F;p&gt;
&lt;p&gt;Each plugin has two functions:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;em&gt;register&lt;&#x2F;em&gt;. Will be called before wasm initialization. Can add additional function to wasm&#x27;s import table: to make plugins JS code available for wasm.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;em&gt;set_wasm_refs&lt;&#x2F;em&gt;. Will be called after successful wasm initialization and to allow plugin store wasm&#x27;s export table and wasm&#x27;s memory - to call any rust function available later in JS.&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;p&gt;To add plugin call &amp;quot;miniquad_add_plugin&amp;quot; from plugin&#x27;s JS file. &amp;quot;gl.js&amp;quot; should be already imported with &lt;code&gt;&amp;lt;script&amp;gt;&lt;&#x2F;code&gt; in the current web page. &lt;&#x2F;p&gt;
&lt;p&gt;Minimal example: &lt;&#x2F;p&gt;
&lt;p&gt;main.rs:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;extern &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;C&amp;quot; &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;hi_from_js&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;#[no_mangle]
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;extern &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;C&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;hi_from_rust&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; we can call JS from rust!
&lt;&#x2F;span&gt;&lt;span&gt;  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;hi_from_js&lt;&#x2F;span&gt;&lt;span&gt;(); 
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;struct &lt;&#x2F;span&gt;&lt;span&gt;Stage;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;impl &lt;&#x2F;span&gt;&lt;span&gt;EventHandler &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;for &lt;&#x2F;span&gt;&lt;span&gt;Stage {
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;update&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;mut &lt;&#x2F;span&gt;&lt;span&gt;self, _ctx: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;mut&lt;&#x2F;span&gt;&lt;span&gt; Context) {}
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;draw&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;mut &lt;&#x2F;span&gt;&lt;span&gt;self, _ctx: &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;&amp;amp;mut&lt;&#x2F;span&gt;&lt;span&gt; Context) {}
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;main&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;    miniquad::start(conf::Conf::default(), |&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;mut &lt;&#x2F;span&gt;&lt;span&gt;ctx| {      
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;Box&lt;&#x2F;span&gt;&lt;span&gt;::new(Stage))
&lt;&#x2F;span&gt;&lt;span&gt;    });
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;pre data-lang=&quot;plugin.js&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-plugin.js &quot;&gt;&lt;code class=&quot;language-plugin.js&quot; data-lang=&quot;plugin.js&quot;&gt;&lt;span&gt;register_plugin = function (importObject) {
&lt;&#x2F;span&gt;&lt;span&gt;    importObject.env.hi_from_wasm = function (js_object) {
&lt;&#x2F;span&gt;&lt;span&gt;        console.log(&amp;quot;hi&amp;quot;)
&lt;&#x2F;span&gt;&lt;span&gt;    }
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;document.onclick = function () {
&lt;&#x2F;span&gt;&lt;span&gt;    &#x2F;&#x2F; and rust from JS!
&lt;&#x2F;span&gt;&lt;span&gt;    wasm_exports.hi_from_rust();
&lt;&#x2F;span&gt;&lt;span&gt;};
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;&#x2F;&#x2F; miniquad_add_plugin receive an object with two fields: register_plugin and on_init. Both are functions, both are optional.
&lt;&#x2F;span&gt;&lt;span&gt;miniquad_add_plugin({register_plugin});
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;index.html&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;html&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-html &quot;&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;head&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;meta &lt;&#x2F;span&gt;&lt;span style=&quot;color:#795da3;&quot;&gt;charset&lt;&#x2F;span&gt;&lt;span&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;utf-8&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;title&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;TITLE&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;title&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;style&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;html&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;body&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;canvas &lt;&#x2F;span&gt;&lt;span&gt;{
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;margin&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;px&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;padding&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;px&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;width&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;100&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;height&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;100&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;%&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;overflow&lt;&#x2F;span&gt;&lt;span&gt;: hidden;
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;position&lt;&#x2F;span&gt;&lt;span&gt;: absolute;
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;background&lt;&#x2F;span&gt;&lt;span&gt;: black;
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;z-index&lt;&#x2F;span&gt;&lt;span&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#0086b3;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;        }
&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;style&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;head&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;body&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;canvas &lt;&#x2F;span&gt;&lt;span style=&quot;color:#795da3;&quot;&gt;id&lt;&#x2F;span&gt;&lt;span&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;glcanvas&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#795da3;&quot;&gt;tabindex&lt;&#x2F;span&gt;&lt;span&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;#39;1&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;canvas&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;script &lt;&#x2F;span&gt;&lt;span style=&quot;color:#795da3;&quot;&gt;src&lt;&#x2F;span&gt;&lt;span&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;https:&#x2F;&#x2F;not-fl3.github.io&#x2F;miniquad-samples&#x2F;gl.js&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;script&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;script &lt;&#x2F;span&gt;&lt;span style=&quot;color:#795da3;&quot;&gt;src&lt;&#x2F;span&gt;&lt;span&gt;=&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;plugin.js&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;script&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &amp;lt;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;script&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;load(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;sapp-jsutils.wasm&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;);&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;script&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;body&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;&amp;lt;&#x2F;&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;html&lt;&#x2F;span&gt;&lt;span&gt;&amp;gt;
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;The very good thing about WASM - that everything is super transparent and straightforward. console.log(wasm_exports) will give a very clear picture of whats going on, what functions are available. And so on - each object is debug friendly.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;type-system-helpers&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#type-system-helpers&quot; aria-label=&quot;Anchor link for: type-system-helpers&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Type system helpers&lt;&#x2F;h1&gt;
&lt;p&gt;Now we know how to call JS from rust and Rust from JS. 
The problem - functions are very limited in available types. Only f32&#x2F;f64, i8&#x2F;u8, i32&#x2F;u32 (and not i64&#x2F;u64) and pointers are available.
Surprisingly, usually it is enough - for games there are not many FFI functions and rolling your own buffer converter from wasm memory to JS memory is good enough.
But there is &lt;code&gt;sapp-jsutils&lt;&#x2F;code&gt; plugin available that can help with working with strings or even arbitrary JS objects. &lt;&#x2F;p&gt;
&lt;p&gt;With &lt;code&gt;sapp-utils&lt;&#x2F;code&gt; rust code may look like this: &lt;&#x2F;p&gt;
&lt;pre style=&quot;background-color:#ffffff;color:#323232;&quot;&gt;&lt;code&gt;&lt;span&gt;#[no_mangle]
&lt;&#x2F;span&gt;&lt;span&gt;pub extern &amp;quot;C&amp;quot; fn hi_rust(js_object: JsObject) {
&lt;&#x2F;span&gt;&lt;span&gt;    let mut message = String::new();
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    js_object.to_string(&amp;amp;mut message);
&lt;&#x2F;span&gt;&lt;span&gt;    miniquad::debug!(&amp;quot;{}&amp;quot;, message);
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;For more info check &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;not-fl3&#x2F;miniquad-js-interop-demo.git&quot;&gt;demo project&lt;&#x2F;a&gt;. This example showcase usage of strings, arrays and structs bi-directional usage - complex types are used in both argument and return positions for both JS and Rust calls.&lt;&#x2F;p&gt;
&lt;p&gt;Note that &lt;code&gt;sapp-utils&lt;&#x2F;code&gt; are completely optional and just one of the options to help with JS-Rust interops. I believe there are way better and efficient ways to do this, depending on the task and requirements. I hope case-specifc crates like &lt;code&gt;sapp-utils&lt;&#x2F;code&gt; will appear to make JS interop easier!&lt;&#x2F;p&gt;
</content>
	</entry>
	<entry xml:lang="en">
		<title>Cross-platform logs</title>
		<published>2020-04-01T09:19:42+00:00</published>
		<updated>2020-04-01T09:19:42+00:00</updated>
		<link rel="alternate" href="https://macroquad.rs/articles/logs/" type="text/html"/>
		<id>https://macroquad.rs/articles/logs/</id>
		<content type="html">&lt;h1 id=&quot;cross-platform-logs-with-miniquad&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#cross-platform-logs-with-miniquad&quot; aria-label=&quot;Anchor link for: cross-platform-logs-with-miniquad&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;Cross-platform logs with miniquad&lt;&#x2F;h1&gt;
&lt;p&gt;Miniquad is cross-platform layer between rust code and target platforms rendering API. Console API necessary for logs are some kind of output API and its on miniquads responsibility to abstract it away. On the other hand, using log-rs with different frontends are the most common way to do logging in rust cosystem.&lt;&#x2F;p&gt;
&lt;p&gt;So there are two different ways to send log messages into console with miniquad:&lt;&#x2F;p&gt;
&lt;h2 id=&quot;with-log-rs&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#with-log-rs&quot; aria-label=&quot;Anchor link for: with-log-rs&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;With log-rs&lt;&#x2F;h2&gt;
&lt;p&gt;Use debug!, warn!, trace!, info! macroses from log-rs just like with any other library. The only issue - special logging frontend for wasm will be needed. Fortunately, there is one: sapp-console-log.&lt;&#x2F;p&gt;
&lt;p&gt;dependencies to Cargo.toml:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;toml&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-toml &quot;&gt;&lt;code class=&quot;language-toml&quot; data-lang=&quot;toml&quot;&gt;&lt;span&gt;[dependencies]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;log &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;0.4&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;[target.wasm32-unknown-unknown.dependencies]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;sapp-console-log &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;0.1&amp;quot;
&lt;&#x2F;span&gt;&lt;span&gt;[target.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;#39;cfg(not(target_arch = &amp;quot;wasm32&amp;quot;)&amp;#39;&lt;&#x2F;span&gt;&lt;span&gt;.dependencies]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;env_logger &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;0.7&amp;quot; &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;# any other log-rs frontend will work fine as well
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;initialization in main.rs:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;main&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;    #[cfg(target_arch &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;wasm32&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;)]
&lt;&#x2F;span&gt;&lt;span&gt;    sapp_console_log::init().&lt;&#x2F;span&gt;&lt;span style=&quot;color:#62a35c;&quot;&gt;unwrap&lt;&#x2F;span&gt;&lt;span&gt;();
&lt;&#x2F;span&gt;&lt;span&gt;    #[cfg(not(target_arch &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;wasm32&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;))]
&lt;&#x2F;span&gt;&lt;span&gt;    env_logger::init();
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span&gt;    info!(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Logging is initialized!&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;); &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; this will be `console.info` on web or handled and filtred by env_logger into stderr
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;with-embedded-logging-implementation&quot;&gt;&lt;a class=&quot;zola-anchor&quot; href=&quot;#with-embedded-logging-implementation&quot; aria-label=&quot;Anchor link for: with-embedded-logging-implementation&quot;&gt;ðŸ”—&lt;&#x2F;a&gt;With embedded logging implementation&lt;&#x2F;h2&gt;
&lt;p&gt;If the main target platform is wasm - there are not much of a choice, just sapp_console_log. miniquad can provide its own logging macroses, very similar to log-rs ones. Each logging call will be redirected into appropriate console.*() call on wasm and just into eprintln!() on desktop.&lt;&#x2F;p&gt;
&lt;p&gt;To use this, enable miniquad &amp;quot;log-impl&amp;quot; feature in Cargo.toml:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;toml&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-toml &quot;&gt;&lt;code class=&quot;language-toml&quot; data-lang=&quot;toml&quot;&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;#[dependencies]
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;miniquad &lt;&#x2F;span&gt;&lt;span&gt;= { &lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;version &lt;&#x2F;span&gt;&lt;span&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;0.2&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#63a35c;&quot;&gt;features &lt;&#x2F;span&gt;&lt;span&gt;= [ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;log-impl&amp;quot; &lt;&#x2F;span&gt;&lt;span&gt;]}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;And then all logging macroses will be available just from miniquad:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;rust&quot; style=&quot;background-color:#ffffff;color:#323232;&quot; class=&quot;language-rust &quot;&gt;&lt;code class=&quot;language-rust&quot; data-lang=&quot;rust&quot;&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;use &lt;&#x2F;span&gt;&lt;span&gt;miniquad::info;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#a71d5d;&quot;&gt;fn &lt;&#x2F;span&gt;&lt;span style=&quot;font-weight:bold;color:#795da3;&quot;&gt;main&lt;&#x2F;span&gt;&lt;span&gt;() {
&lt;&#x2F;span&gt;&lt;span&gt;    info!(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#183691;&quot;&gt;&amp;quot;Logging is available!&amp;quot;&lt;&#x2F;span&gt;&lt;span&gt;); &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#969896;&quot;&gt;&#x2F;&#x2F; this will be `console.info` on web and `eprintln!` on desktop
&lt;&#x2F;span&gt;&lt;span&gt;}
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
</content>
	</entry>
</feed>
