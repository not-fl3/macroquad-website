<!DOCTYPE html>
<html lang="en-US">
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" as="font" href="https://macroquad.rs/fonts/vendor/jost/jost-v4-latin-regular.woff2" type="font/woff2" crossorigin>
  <link rel="preload" as="font" href="https://macroquad.rs/fonts/vendor/jost/jost-v4-latin-700.woff2"  type="font/woff2" crossorigin>


  <link rel="stylesheet" type="text/css" href="https://macroquad.rs/semantic.min.css">
  <link rel="stylesheet" type="text/css" href="https://macroquad.rs/fonts.css">

  <style>
    .ui, h1, h2, h3, h4, h5 {
        font-family: "Jost",-apple-system,blinkmacsystemfont,"Segoe UI",roboto,"Helvetica Neue",arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji" !important;
    }
    .zola-anchor {
        font-size: 1.25rem;
        margin-left: -2rem;
        margin-right: 0.75rem;
        text-decoration: none;
        border-bottom-color: transparent;
        cursor: pointer;
      }
  </style>
  <script
    src="https://macroquad.rs/jquery-3.1.1.min.js"
    integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
    crossorigin="anonymous"></script>
  <script src="https://macroquad.rs/semantic.min.js"></script>



  
    
  



  <meta name="theme-color" content="#fff">
  <link rel="apple-touch-icon" sizes="180x180" href="https://macroquad.rs/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://macroquad.rs/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://macroquad.rs/favicon-16x16.png">
  
    <link rel="manifest" href="https://macroquad.rs/site.webmanifest">
  

</head>

<body class="home">
  
    
<div class="ui borderless huge menu">
  <a class=

"item active"

 href="/">
    Macroquad
  </a>
  <a class=

"item"

  href="/examples">
    Examples
  </a>
  <a class=

"item"

 href="/articles">
    Articles
  </a>
  <a class=

"item"

 href="/docs">
    docs.rs
  </a>
  

    <a href="https://github.com/not-fl3/macroquad" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
</div>

<script type="text/javascript">
$(document).ready(function(){
    $(document).on('click','.item',function(e){
        $('.ui .item').removeClass('active');
        $(this).addClass('active');
});
});
</script>


  

  
<style type="text/css">
  .eleven.wide.column {
      font-size: 18px;
  }
  pre,
  code,
  kbd,
  samp {
      font-family: $font-family-monospace;
      font-size: $font-size-sm;
      border-radius: $border-radius;
  }
  
  code {
      background: #f7f7f7;
      //color: $black;
      padding: 0.25rem 0.5rem;
  }
  
  pre {
      margin: 2rem 0;
  }
  
  pre code {
      display: block;
      overflow-x: auto;
      line-height: $line-height-base;
      padding: 1.25rem 1.5rem;
      tab-size: 4;
      scrollbar-width: thin;
      scrollbar-color: transparent transparent;
  }
</style>

<div class="ui grid stackable container">
  <div class="row" id="article">
    <div class="eleven wide centered column">
      <h2 class="ui large header">
        <div class="content">Java interop with Miniquad on Android</div>
      </h2>
      <div class="ui hidden divider"></div>
      <p>Miniquad allows seamless integration of Java code, intagrating Java compilation into a rust build pipeline. This allows *quad project to get access to any Android APIs and an option to integrate any third-party Java libraries.</p>
<p>The article use a native file dialog as an example.</p>
<p>Code is available here: </p>
<p><a href="https://github.com/not-fl3/example-android-fileopen/">https://github.com/not-fl3/example-android-fileopen/</a></p>
<p>More comprehensive example: </p>
<p><a href="https://github.com/not-fl3/example-android-bluetooth/">https://github.com/not-fl3/example-android-bluetooth/</a></p>
<p><figure class="inline-image">
	<video controls autoplay playsinline muted loop>
		<source src="https:&#x2F;&#x2F;user-images.githubusercontent.com&#x2F;910977&#x2F;177233789-fefbf9c9-6c55-4151-804a-22b85dfa82de.mp4" type="video/mp4">
		Your browser does not support the video tag.
	</video>
	
</figure>

<em>Bluetooth example asking for permissions. Surpisingly, its A LOT of java!</em></p>
<h2 id="how-android-runs-things"><a class="zola-anchor" href="#how-android-runs-things" aria-label="Anchor link for: how-android-runs-things">ðŸ”—</a>How android runs things</h2>
<p>First a brief introduction on how applications works on android. A bird's eye view on how apps works on android, to find out where it is possible to insert some calls to get the fial dialog (or any native api, actually) to appear. </p>
<p>Each android package, .apk, is basically a zip archive with:</p>
<ul>
<li>classes.dex file - all the compiled java files</li>
<li>.so files - all the compiled binary code</li>
<li>some .xml's with metadata, resources and assets</li>
</ul>
<p>Android will initialize java virtual machine and run the app inside this virtual machine. All the interactions with the OS goes through the virtual machine. </p>
<p>There are two ways to start android application, described in one of the .xml's of the apk:</p>
<ul>
<li>skip classes.dex completely and tell android to load .so and call a few symbols to let the app initialize.</li>
<li>find a java class in classes.dex file and let it run.</li>
</ul>
<p>Miniquad is using the second option - it have MainActivity.java that is responsible for initializing the app and receiving input events. And inside this MainActivity.java .so with user code is being loaded and some native functions from that .so are being called.</p>
<p>Why miniquad is not built around NativeActivity, the first option? Well, it used to be built around NativeActivity until 0.3, actually.
The problem here - some of the android API's are really, really hard to use through java native interface. So it really helps when there is an option to make a wrapper for something in Java and provide an easy to use function for a native code.</p>
<p><em>A little remark on apks</em> Now instead of raw .apk developers will be forced to use .aab - a new format for applications on android. Each .aab is a bunch of signed .apk's, so the idea is still the ssame.</p>
<h3 id="writing-some-java"><a class="zola-anchor" href="#writing-some-java" aria-label="Anchor link for: writing-some-java">ðŸ”—</a>Writing some java</h3>
<p>A short recap from previous section:</p>
<ul>
<li>miniquad has MainActivity.java</li>
<li>it creates an OS window and load .so with user code</li>
<li>it pass all the events to this .so through calling native functions from .so</li>
</ul>
<p>The way miniquad's native plugins are built are very similar to UE4 android plugin's idea(just in case the reader is familiar with UE4/Android interop).</p>
<p>We can ask the build system to insert some code right to the MainActivity.java. And we can as the build system to add compile some .java files to get the classes into classes.dex.</p>
<p>Adding code inside MainActivity works in a quite literal way - there is a MainActivity.java template: <a href="https://github.com/not-fl3/miniquad/blob/master/java/MainActivity.java">MainActivity.java</a>. Each crate based on miniquad can ask the build system to add some lines into <code>//% MAIN_ACTIVITY_ON_RESUME</code> or <code>//% whatever</code>.</p>
<p>Fortunately Java is not against recurring lines in imprts declaration,</p>
<pre data-lang="java" style="background-color:#ffffff;color:#323232;" class="language-java "><code class="language-java" data-lang="java"><span style="font-weight:bold;color:#a71d5d;">import </span><span style="color:#0086b3;">android</span><span>.</span><span style="color:#0086b3;">app</span><span>.</span><span style="color:#0086b3;">Activity</span><span>;
</span><span style="font-weight:bold;color:#a71d5d;">import </span><span style="color:#0086b3;">android</span><span>.</span><span style="color:#0086b3;">app</span><span>.</span><span style="color:#0086b3;">Activity</span><span>;
</span><span style="font-weight:bold;color:#a71d5d;">import </span><span style="color:#0086b3;">android</span><span>.</span><span style="color:#0086b3;">app</span><span>.</span><span style="color:#0086b3;">Activity</span><span>;
</span></code></pre>
<p>is totally legit for Java. So each plugin can be independent on each other and add its logic right into the MainActivity, with its own imports and its own initialisation code in Activity OnCreate and so on.</p>
<p><strong>The plan of building a file dialog crate</strong></p>
<ul>
<li>Make a few .java files with classes helpful for dealing with files</li>
<li>Ask to insert code into MainActivity.java to make some initialization on java side</li>
<li>Call some functions through JNI from our plugin rust code to get the data back</li>
</ul>
<h2 id="how-to-open-a-file-dialog"><a class="zola-anchor" href="#how-to-open-a-file-dialog" aria-label="Anchor link for: how-to-open-a-file-dialog">ðŸ”—</a>How to open a file dialog</h2>
<p>This part might be generalized into &quot;How to use Intents on Android&quot;. </p>
<p><a href="https://developer.android.com/reference/android/content/Intent">An intent is an abstract description of an operation to be performed. ... An Intent provides a facility for performing late runtime binding between the code in different applications.</a></p>
<p>MainActivity has a method, <code>startActivityForResult</code>. This will replace the application's activity with a new activity for the intent and later will send the result back into MainActivity.</p>
<p>To simplify getting data from a callback (hmm), the docs <a href="https://developer.android.com/training/basics/intents/result">suggests</a> to include 88Mb library with 499 Java files. While this is totally possible (check the bluetooth example, it goes this way), let's try to avoid this for a little dialog.</p>
<p><code>startActivityForResult</code> will send the result into a MainActivity's as a MainActivity's virtual function. Here ability to patch MainActivity comes in handy: <a href="https://github.com/not-fl3/example-android-fileopen/blob/main/java/MainActivity.java">add code into MainActivity</a>.</p>
<h2 id="wrapping-this-into-a-crate"><a class="zola-anchor" href="#wrapping-this-into-a-crate" aria-label="Anchor link for: wrapping-this-into-a-crate">ðŸ”—</a>Wrapping this into a crate</h2>
<p>The goal here - make a crate that provides a <code>find_file</code> function. This function opens a dialog and returns a bytes of a file content.</p>
<p>To tell cargo where are the java files: 
<a href="https://github.com/not-fl3/example-android-fileopen/blob/main/quad.toml">quad.toml</a>:</p>
<pre data-lang="toml" style="background-color:#ffffff;color:#323232;" class="language-toml "><code class="language-toml" data-lang="toml"><span style="color:#63a35c;">main_activity_inject </span><span>= </span><span style="color:#183691;">&quot;java/MainActivity.java&quot;
</span><span style="color:#63a35c;">java_files </span><span>= [
</span><span>    </span><span style="color:#183691;">&quot;java/fileopen/FileOpen.java&quot;</span><span>,
</span><span>]
</span></code></pre>
<p>Java class responsible for the dialog: <a href="https://github.com/not-fl3/example-android-fileopen/blob/main/java/fileopen/FileOpen.java#L16">FileOpen.java</a></p>
<p>Most java calls look like </p>
<pre style="background-color:#ffffff;color:#323232;"><code><span>let env = android::attach_jni_env();
</span><span>ndk_utils::call_void_method!(env, &quot;OpenFileDialog&quot;, &quot;()V&quot;);
</span></code></pre>
<p>Useful links on Rust&lt;-&gt;Java interop:</p>
<p><a href="https://github.com/not-fl3/miniquad/blob/master/src/native/android/ndk_utils.rs">miniquad's ndk_utils</a>
<a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/functions.html">JNI functions(available in the &quot;env&quot;)</a></p>
<h2 id="using-the-crate"><a class="zola-anchor" href="#using-the-crate" aria-label="Anchor link for: using-the-crate">ðŸ”—</a>Using the crate</h2>
<p>This part is simple. 
Just include the crate in Cargo.toml: </p>
<pre data-lang="toml" style="background-color:#ffffff;color:#323232;" class="language-toml "><code class="language-toml" data-lang="toml"><span>[dependencies]
</span><span style="color:#63a35c;">fileopen </span><span>= </span><span style="color:#183691;">&quot;..&quot;
</span></code></pre>
<p>and use it from any miniquad/macroquad project:</p>
<pre style="background-color:#ffffff;color:#323232;"><code><span>if root_ui().button(None, &quot;Open file&quot;){
</span><span>    fileopen::find_file(file_data.clone());
</span><span>}
</span></code></pre>
<h2 id="post-scriptum"><a class="zola-anchor" href="#post-scriptum" aria-label="Anchor link for: post-scriptum">ðŸ”—</a>Post-scriptum</h2>
<p><em>Wait is a second, patching java code, calling javac, isn't it all horrible hacks?</em></p>
<p><em>Yes it is indeed. Would be so happy to throw it all away! But so far its the easiest way to deal with java I ever seen (from a library user perspective, writing java is horrible). No need to download gigabytes of android studio, no build pipeline complications.</em></p>

    </div>
  </div>
</div>



  
    
<footer class="ui inverted vertical footer segment" style="padding: 2em 0em; margin-top: 3em;">
	<div class="ui container" style="">
		<div class="ui stackable inverted divided equal height stackable grid">
			<div class="eight wide column">
                <h4 class="ui inverted header">Powered by</h4>
                <div class="ui inverted link list">
                    <a class="item" href="https://www.getzola.org/">Zola</a>
                    <a class="item" href="https://semantic-ui.com">Semantic UI</a>
                </div>
            </div>
            <div class="eight wide column">
                <h4 class="ui inverted header">Page source</h4>
                <div class="ui inverted link list">
                    <a class="item" href="https://github.com/not-fl3/macroquad-examples/">macroquad-website</a>
                </div>
            </div>
		</div>
	</div>
</footer>

  

</body>
</html>
